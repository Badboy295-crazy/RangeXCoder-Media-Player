<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>RangeXCoder - Professional Video Player</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    :root {
      --primary: #4f46e5;
      --primary-dark: #3730a3;
      --secondary: #22c55e;
      --secondary-dark: #15803d;
      --danger: #e11d48;
      --danger-dark: #9f1239;
      --light: #f8fafc;
      --dark: #0f172a;
      --gray: #64748b;
      --gray-light: #cbd5e1;
      --card-bg: #ffffff;
      --card-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light);
      color: var(--dark);
      padding: 1rem;
      transition: background-color 0.3s, color 0.3s;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Night Mode Styles */
    body.night-mode {
      background-color: #0f172a;
      color: #e2e8f0;
    }

    body.night-mode .header {
      border-bottom-color: #334155;
    }

    body.night-mode .card-bg,
    body.night-mode .video-wrapper,
    body.night-mode #controlsPanel,
    body.night-mode #downloadModal .modal-content {
      background-color: #1e293b;
      color: #e2e8f0;
    }

    body.night-mode .shortcut-item {
      background-color: rgba(79, 70, 229, 0.1);
    }

    body.night-mode .shortcut-action {
      color: #e2e8f0;
    }

    body.night-mode .video-controls {
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    }

    body.night-mode .progress-container {
      background-color: rgba(255,255,255,0.2);
    }

    body.night-mode .volume-slider {
      background-color: rgba(255,255,255,0.2);
    }

    .header {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--gray-light);
    }

    .header h1 {
      font-weight: 800;
      color: var(--primary);
      margin: 0;
      font-size: 1.8rem;
      margin-right: auto;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo {
      width: 40px;
      height: 40px;
      background: var(--primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .header-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    /* Night Mode Toggle Button */
    .night-mode-toggle {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--gray);
      cursor: pointer;
      transition: color 0.3s;
      margin-right: 0.5rem;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .night-mode-toggle:hover {
      background-color: rgba(79, 70, 229, 0.1);
      color: var(--primary);
    }

    .controls-button, .download-button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .controls-button:hover {
      background-color: var(--primary-dark);
    }

    .download-button {
      background-color: var(--secondary);
    }

    .download-button:hover {
      background-color: var(--secondary-dark);
    }

    .player-container {
      max-width: 100%;
      margin: 0 auto;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .video-wrapper {
      background-color: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
      margin-bottom: 1.5rem;
      position: relative;
      width: 100%;
      height: 75vh;
      min-height: 500px;
      cursor: pointer;
    }

    video {
      width: 100%;
      height: 100%;
      display: block;
      outline: none;
      object-fit: contain;
      cursor: pointer;
    }

    /* Video Controls Styling */
    .video-controls {
      background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      opacity: 1;
      transition: opacity 0.3s ease;
      z-index: 100;
      pointer-events: none;
    }

    /* Video controls ??? buttons ?? ??? pointer events enable */
    .video-controls .control-btn,
    .video-controls .pip-btn,
    .video-controls .audio-boost-btn,
    .video-controls .playback-speed-btn,
    .video-controls .quality-btn,
    .video-controls .volume-slider,
    .video-controls .progress-container,
    .video-controls .speed-option,
    .video-controls .quality-option {
      pointer-events: auto;
    }

    /* Normal Mode Controls */
    .video-wrapper:not(.fullscreen) .video-controls {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 1rem;
      height: 70px;
      background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
      opacity: 1 !important; /* Normal mode ??? ????? visible */
      pointer-events: auto !important;
    }

    .video-wrapper:not(.fullscreen) .right-controls {
      display: flex !important;
      align-items: center;
      gap: 0.5rem;
    }

    .video-wrapper:not(.fullscreen) .right-controls > *:not(#fullscreenBtn) {
      display: none !important;
    }

    .video-wrapper:not(.fullscreen) .left-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .video-wrapper:not(.fullscreen) .progress-container {
      display: block !important;
      position: absolute;
      bottom: 70px;
      left: 1rem;
      right: 1rem;
      height: 4px;
      margin: 0;
      background-color: rgba(255,255,255,0.3);
      border-radius: 2px;
      cursor: pointer;
    }

    .video-wrapper:not(.fullscreen) .progress-bar {
      height: 100%;
      background-color: var(--primary);
      border-radius: 2px;
      width: 0%;
    }

    .video-wrapper:not(.fullscreen) .progress-handle {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 12px;
      height: 12px;
      background-color: var(--primary);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }

    .video-wrapper:not(.fullscreen) .progress-container:hover .progress-handle,
    .video-wrapper:not(.fullscreen) .progress-container.dragging .progress-handle {
      opacity: 1;
    }

    .video-wrapper:not(.fullscreen) .time-display {
      color: white;
      font-size: 0.9rem;
      font-weight: 500;
      font-family: 'Courier New', monospace;
      min-width: 130px;
      text-align: center;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    .video-wrapper:not(.fullscreen) .control-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    /* Normal Mode ??? ?????? ?? ??? */
    .video-wrapper:not(.fullscreen) .pip-btn,
    .video-wrapper:not(.fullscreen) .audio-boost-btn,
    .video-wrapper:not(.fullscreen) .playback-speed,
    .video-wrapper:not(.fullscreen) .quality-selector,
    .video-wrapper:not(.fullscreen) .volume-container {
      display: none !important;
    }

    /* Full Screen ??? ??? Controls ?????? */
    .video-wrapper.fullscreen .video-controls {
      flex-direction: column;
      padding: 1rem;
      opacity: 1;
    }

    .video-wrapper.fullscreen .control-buttons {
      display: flex;
      justify-content: space-between;
      width: 100%;
    }

    .video-wrapper.fullscreen .right-controls {
      display: flex !important;
      align-items: center;
      gap: 1rem;
    }

    .video-wrapper.fullscreen .progress-container {
      display: block !important;
      width: 100%;
      position: static;
      height: 6px;
      left: 0;
      right: 0;
      margin: 0;
    }

    .video-wrapper.fullscreen .progress-bar {
      height: 100%;
      background-color: var(--primary);
      border-radius: 3px;
      width: 0%;
    }

    .video-wrapper.fullscreen .progress-handle {
      width: 16px;
      height: 16px;
    }

    /* Hide controls in fullscreen */
    .video-wrapper.fullscreen .video-controls.hidden {
      opacity: 0 !important;
      pointer-events: none !important;
    }

    .video-wrapper.fullscreen .video-controls:not(.hidden) {
      opacity: 1 !important;
      pointer-events: all !important;
    }

    /* Progress Bar */
    .progress-container {
      width: 100%;
      height: 6px;
      background-color: rgba(255,255,255,0.3);
      border-radius: 3px;
      cursor: pointer;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      background-color: var(--primary);
      border-radius: 3px;
      width: 0%;
    }

    .progress-handle {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 16px;
      height: 16px;
      background-color: var(--primary);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }

    .progress-container:hover .progress-handle,
    .progress-container.dragging .progress-handle {
      opacity: 1;
    }

    /* Control Buttons Layout */
    .control-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .left-controls, .right-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .control-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      transition: color 0.2s;
    }

    .control-btn:hover {
      color: var(--primary);
    }

    /* Special control buttons */
    .pip-btn, .audio-boost-btn, .playback-speed-btn, .quality-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .pip-btn:hover, .audio-boost-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .pip-btn.active, .audio-boost-btn.active {
      background: var(--primary);
    }

    .time-display {
      color: white;
      font-size: 0.9rem;
      font-weight: 500;
      font-family: 'Courier New', monospace;
      min-width: 130px;
      text-align: center;
    }

    .volume-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .volume-slider {
      width: 80px;
      height: 4px;
      background-color: rgba(255,255,255,0.3);
      border-radius: 2px;
      position: relative;
      cursor: pointer;
    }

    .volume-level {
      height: 100%;
      background-color: white;
      border-radius: 2px;
      width: 100%;
    }

    .playback-speed, .quality-selector {
      position: relative;
    }

    .playback-speed-btn:hover, .quality-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .speed-options, .quality-options {
      position: absolute;
      bottom: 100%;
      right: 0;
      background: rgba(0,0,0,0.8);
      border-radius: 6px;
      padding: 0.5rem;
      display: none;
      flex-direction: column;
      gap: 0.3rem;
      min-width: 100px;
      z-index: 100;
      max-height: 300px;
      overflow-y: auto;
    }

    .playback-speed:hover .speed-options, 
    .quality-selector:hover .quality-options {
      display: flex;
    }

    .speed-option, .quality-option {
      background: none;
      border: none;
      color: white;
      padding: 0.4rem 0.8rem;
      text-align: left;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .speed-option:hover, .quality-option:hover {
      background: rgba(255,255,255,0.1);
    }

    .speed-option.active, .quality-option.active {
      background: var(--primary);
    }

    .back-button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 10;
    }

    .back-button:hover {
      background-color: var(--primary-dark);
    }

    /* Seek Animation */
    .seek-animation {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(79, 70, 229, 0.95);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      font-weight: bold;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      animation: seekFade 2s ease-out;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
      backdrop-filter: blur(5px);
      border: 2px solid rgba(255,255,255,0.2);
    }

    .seek-animation.forward {
      background-color: rgba(34, 197, 94, 0.95);
    }

    .seek-animation.backward {
      background-color: rgba(239, 68, 68, 0.95);
    }

    @keyframes seekFade {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.7);
      }
      20% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.1);
      }
      40% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      70% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(1.2);
      }
    }

    /* Audio Boost Indicator */
    .audio-boost-indicator {
      position: absolute;
      top: 15px;
      right: 15px;
      background-color: rgba(34, 197, 94, 0.9);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .audio-boost-indicator.show {
      opacity: 1;
    }

    /* Loading Spinner */
    #loadingSpinner {
      position: absolute;
      z-index: 10;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      user-select: none;
      text-align: center;
      background: rgba(0,0,0,0.7);
      padding: 2rem;
      border-radius: 12px;
    }

    .dots-loader {
      display: inline-block;
      width: 60px;
      height: 20px;
    }

    .dots-loader > div {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin: 0 5px;
      background-color: var(--primary);
      border-radius: 50%;
      animation-name: dotsBounce;
      animation-duration: 1.4s;
      animation-iteration-count: infinite;
      animation-timing-function: ease-in-out;
    }

    .dots-loader > div:nth-child(1) { animation-delay: -0.32s; }
    .dots-loader > div:nth-child(2) { animation-delay: -0.16s; }

    @keyframes dotsBounce {
      0%, 80%, 100% { transform: scale(0); opacity: 0.3; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* Controls Panel */
    #controlsPanel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 380px;
      height: 100vh;
      background-color: var(--card-bg);
      box-shadow: -5px 0 15px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: right 0.3s ease;
      padding: 2rem;
      overflow-y: auto;
    }

    #controlsPanel.open {
      right: 0;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--gray-light);
    }

    .panel-header h2 {
      color: var(--primary);
      margin: 0;
    }

    .close-panel {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--gray);
      cursor: pointer;
      transition: color 0.2s;
    }

    .close-panel:hover {
      color: var(--danger);
    }

    .shortcuts-section {
      margin-bottom: 2rem;
    }

    .shortcuts-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--primary);
    }

    .shortcuts-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .shortcut-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.8rem;
      background-color: rgba(79, 70, 229, 0.05);
      border-radius: 8px;
    }

    .shortcut-key {
      background-color: var(--primary);
      color: white;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      min-width: 60px;
      text-align: center;
    }

    .shortcut-action {
      font-size: 0.9rem;
      color: var(--dark);
    }

    /* Download Modal Styles */
    #downloadModal {
      display: none;
      position: fixed;
      z-index: 1050;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
    }

    #downloadModal .modal-content {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 2rem;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    #downloadModal .modal-content h3 {
      margin-bottom: 1rem;
      color: var(--primary);
    }

    #downloadModal .modal-content p {
      margin-bottom: 1.5rem;
      font-size: 1rem;
      color: var(--dark);
    }

    #downloadModal .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
    }

    #downloadModal button.start-download {
      background-color: var(--secondary);
      color: white;
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #downloadModal button.start-download:hover {
      background-color: var(--secondary-dark);
    }

    #downloadModal button.cancel-download {
      background-color: var(--danger);
      color: white;
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #downloadModal button.cancel-download:hover {
      background-color: var(--danger-dark);
    }

    /* Mobile Landscape Mode */
    @media screen and (max-width: 768px) {
      body {
        padding: 0.5rem;
      }
      
      .header h1 {
        font-size: 1.5rem;
      }
      
      .video-wrapper {
        height: 60vh;
        min-height: 400px;
      }
      
      .video-wrapper:not(.fullscreen) .video-controls {
        height: 60px;
        padding: 0.5rem;
      }
      
      .video-wrapper:not(.fullscreen) .time-display {
        font-size: 0.8rem;
        min-width: 110px;
      }
      
      .video-wrapper.fullscreen .right-controls {
        gap: 0.5rem;
      }
      
      .pip-btn, .audio-boost-btn, .playback-speed-btn, .quality-btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
      }
      
      #controlsPanel {
        width: 300px;
      }
      
      .volume-slider {
        width: 60px;
      }
      
      /* Mobile fullscreen landscape mode */
      @media (orientation: landscape) {
        .video-wrapper.fullscreen {
          height: 100vh !important;
          width: 100vw !important;
          min-height: 100vh !important;
          border-radius: 0 !important;
          margin: 0 !important;
          padding: 0 !important;
        }
        
        .video-wrapper.fullscreen video {
          object-fit: contain !important;
          height: 100vh !important;
          width: 100vw !important;
        }
        
        .video-wrapper.fullscreen .video-controls {
          padding: 0.8rem !important;
        }
        
        .video-wrapper.fullscreen .control-btn {
          font-size: 1rem !important;
        }
        
        .video-wrapper.fullscreen .time-display {
          font-size: 0.8rem !important;
          min-width: 100px !important;
        }
        
        .video-wrapper.fullscreen .pip-btn,
        .video-wrapper.fullscreen .audio-boost-btn,
        .video-wrapper.fullscreen .playback-speed-btn,
        .video-wrapper.fullscreen .quality-btn {
          padding: 0.2rem 0.4rem !important;
          font-size: 0.7rem !important;
        }
      }
    }
    
    @media (max-width: 480px) {
      .video-wrapper {
        height: 50vh;
        min-height: 300px;
      }
      
      .header-controls {
        flex-direction: column;
        gap: 0.3rem;
      }
      
      .controls-button, .download-button {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }
      
      .night-mode-toggle {
        margin-right: 0;
        margin-bottom: 0.3rem;
      }
      
      .video-wrapper:not(.fullscreen) .time-display {
        font-size: 0.7rem;
        min-width: 90px;
      }
      
      .video-wrapper:not(.fullscreen) .video-controls {
        height: 50px;
      }
      
      .video-wrapper:not(.fullscreen) .progress-container {
        bottom: 50px;
        left: 0.5rem;
        right: 0.5rem;
      }
      
      /* Mobile landscape mode for small screens */
      @media (orientation: landscape) {
        .video-wrapper.fullscreen {
          height: 100vh !important;
          min-height: 100vh !important;
        }
        
        .video-wrapper.fullscreen video {
          height: 100vh !important;
        }
        
        body {
          padding: 0 !important;
          margin: 0 !important;
        }
        
        .player-container {
          width: 100vw !important;
          height: 100vh !important;
        }
      }
    }
  </style>
</head>
<body>

  <div class="player-container">
    <div class="header">
      <h1>
        <div class="logo">RX</div>
        RangeXCoder
      </h1>
      <div class="header-controls">
        <button class="night-mode-toggle" id="nightModeToggle" title="Toggle Night Mode">
          <i class="ri-moon-line" id="nightModeIcon"></i>
        </button>
        <button class="controls-button" onclick="toggleControlsPanel()">
          <i class="ri-keyboard-line"></i> Controls
        </button>
        <button class="download-button" onclick="openDownloadModal()">
          <i class="ri-download-line"></i> Download
        </button>
      </div>
    </div>

    <div class="video-wrapper" id="playerContainer">
      <div id="loadingSpinner" aria-label="Loading video">
        <div class="dots-loader" aria-hidden="true">
          <div></div><div></div><div></div>
        </div>
        <p style="margin-top: 0.5rem; color: white; font-weight: 600;">Loading video...</p>
      </div>
      
      <div id="seekAnimation" class="seek-animation" style="display: none;"></div>
      
      <div id="audioBoostIndicator" class="audio-boost-indicator">
        <i class="ri-volume-up-fill"></i>
        <span id="audioBoostValue">100%</span>
      </div>
      
      <button class="back-button" onclick="goBack()" title="Back to Lectures" aria-label="Back to Lectures">
        <i class="ri-arrow-left-line"></i> Back
      </button>
      
      <div class="video-controls" id="videoControls">
        <div class="progress-container" id="progressContainer">
          <div class="progress-bar" id="progressBar"></div>
          <div class="progress-handle" id="progressHandle"></div>
        </div>
        
        <div class="control-buttons">
          <div class="left-controls">
            <button class="control-btn" id="playPauseBtn" title="Play/Pause">
              <i class="ri-play-fill"></i>
            </button>
            <div class="time-display">
              <span id="currentTime">0:00:00</span> / <span id="duration">0:00:00</span>
            </div>
          </div>
          
          <div class="right-controls">
            <button class="audio-boost-btn" id="audioBoostBtn" title="Audio Boost">
              <i class="ri-volume-up-line"></i>
              <span id="audioBoostText">100%</span>
            </button>
            
            <div class="volume-container">
              <button class="control-btn" id="volumeBtn" title="Mute/Unmute">
                <i class="ri-volume-up-fill"></i>
              </button>
              <div class="volume-slider" id="volumeSlider">
                <div class="volume-level" id="volumeLevel"></div>
              </div>
            </div>
            
            <button class="pip-btn" id="pipBtn" title="Picture-in-Picture">
              <i class="ri-picture-in-picture-line"></i>
            </button>
            
            <div class="playback-speed">
              <button class="playback-speed-btn" id="speedBtn">1x</button>
              <div class="speed-options" id="speedOptions">
                <button class="speed-option" data-speed="0.25">0.25x</button>
                <button class="speed-option" data-speed="0.5">0.5x</button>
                <button class="speed-option" data-speed="0.75">0.75x</button>
                <button class="speed-option active" data-speed="1">1x</button>
                <button class="speed-option" data-speed="1.25">1.25x</button>
                <button class="speed-option" data-speed="1.5">1.5x</button>
                <button class="speed-option" data-speed="2">2x</button>
                <button class="speed-option" data-speed="2.5">2.5x</button>
                <button class="speed-option" data-speed="3">3x</button>
                <button class="speed-option" data-speed="4">4x</button>
                <button class="speed-option" data-speed="5">5x</button>
              </div>
            </div>
            
            <div class="quality-selector">
              <button class="quality-btn" id="qualityBtn">Quality</button>
              <div class="quality-options" id="qualityOptions">
              </div>
            </div>
            
            <button class="control-btn" id="fullscreenBtn" title="Fullscreen">
              <i class="ri-fullscreen-fill"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="controlsPanel">
    <div class="panel-header">
      <h2>Player Controls</h2>
      <button class="close-panel" onclick="toggleControlsPanel()">
        <i class="ri-close-line"></i>
      </button>
    </div>
    
    <div class="shortcuts-section">
      <h3 class="shortcuts-title">Keyboard Shortcuts</h3>
      <div class="shortcuts-grid">
        <div class="shortcut-item">
          <span class="shortcut-key">Space</span>
          <span class="shortcut-action">Play/Pause</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">F</span>
          <span class="shortcut-action">Fullscreen</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">M</span>
          <span class="shortcut-action">Mute/Unmute</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">P</span>
          <span class="shortcut-action">Picture-in-Picture</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">B</span>
          <span class="shortcut-action">Audio Boost</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">?</span>
          <span class="shortcut-action">Seek -10s</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">?</span>
          <span class="shortcut-action">Seek +10s</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">?</span>
          <span class="shortcut-action">Volume +10%</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">?</span>
          <span class="shortcut-action">Volume -10%</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">0-9</span>
          <span class="shortcut-action">Seek to %</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">R</span>
          <span class="shortcut-action">Restart</span>
        </div>
      </div>
    </div>
    
    <div class="shortcuts-section">
      <h3 class="shortcuts-title">Mobile Controls</h3>
      <div class="shortcuts-grid">
        <div class="shortcut-item">
          <span class="shortcut-key">Tap</span>
          <span class="shortcut-action">Show/Hide Controls</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Double Tap Left</span>
          <span class="shortcut-action">Rewind 10s</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Double Tap Right</span>
          <span class="shortcut-action">Forward 10s</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Swipe Left/Right</span>
          <span class="shortcut-action">Volume</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Drag/Hold Progress</span>
          <span class="shortcut-action">Seek Video</span>
        </div>
      </div>
    </div>
  </div>

  <div id="downloadModal" role="dialog" aria-modal="true" aria-labelledby="downloadModalTitle" aria-describedby="downloadModalDesc">
    <div class="modal-content">
      <h3 id="downloadModalTitle">Download Video</h3>
      <p id="downloadModalDesc">This will open the 1DM app to download the video.</p>
      
      <div class="modal-buttons">
        <button class="start-download" onclick="startDownloadWith1DM()" id="startDownloadBtn">Open in 1DM</button>
        <button class="cancel-download" onclick="closeDownloadModal()">Cancel</button>
      </div>
    </div>
  </div>

<script>
  const params = new URLSearchParams(window.location.search);
  const title = params.get('title') || 'Video';
  let url = params.get('url') || '';
  if (!url && params.get('video')) {
    try { url = atob(params.get('video')); } catch {}
  }

  const container = document.getElementById('playerContainer');
  const spinner = document.getElementById('loadingSpinner');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const currentTimeEl = document.getElementById('currentTime');
  const durationEl = document.getElementById('duration');
  const progressBar = document.getElementById('progressBar');
  const progressContainer = document.getElementById('progressContainer');
  const progressHandle = document.getElementById('progressHandle');
  const volumeBtn = document.getElementById('volumeBtn');
  const volumeSlider = document.getElementById('volumeSlider');
  const volumeLevel = document.getElementById('volumeLevel');
  const speedBtn = document.getElementById('speedBtn');
  const speedOptions = document.getElementById('speedOptions');
  const qualityBtn = document.getElementById('qualityBtn');
  const qualityOptions = document.getElementById('qualityOptions');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const controlsPanel = document.getElementById('controlsPanel');
  const downloadModal = document.getElementById("downloadModal");
  const startDownloadBtn = document.getElementById("startDownloadBtn");
  const nightModeToggle = document.getElementById("nightModeToggle");
  const nightModeIcon = document.getElementById("nightModeIcon");
  const seekAnimation = document.getElementById("seekAnimation");
  const videoControls = document.getElementById("videoControls");
  const pipBtn = document.getElementById('pipBtn');
  const audioBoostBtn = document.getElementById('audioBoostBtn');
  const audioBoostText = document.getElementById('audioBoostText');
  const audioBoostIndicator = document.getElementById('audioBoostIndicator');
  const audioBoostValue = document.getElementById('audioBoostValue');

  let video;
  let lastTap = 0;
  let speedHeld = false;
  let isDraggingProgress = false;
  let isDraggingVolume = false;
  let currentPlaybackSpeed = 1;
  let savedVolume = 1;
  let hls;
  let controlsHideTimeout;
  let isFullscreen = false;
  let areControlsVisible = true;
  const CONTROLS_HIDE_DELAY = 3000;
  let audioBoostLevel = 1.0;
  const MAX_AUDIO_BOOST = 3.0;
  let isPipActive = false;
  let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

  function formatTime(seconds) {
    const hrs = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hrs > 0) {
      return `${hrs}:${mins < 10 ? '0' : ''}${mins}:${secs < 10 ? '0' : ''}${secs}`;
    } else {
      return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }
  }

  function toggleNightMode() {
    document.body.classList.toggle('night-mode');
    if (document.body.classList.contains('night-mode')) {
      nightModeIcon.className = 'ri-sun-line';
      localStorage.setItem('nightMode', 'enabled');
    } else {
      nightModeIcon.className = 'ri-moon-line';
      localStorage.setItem('nightMode', 'disabled');
    }
  }

  function checkNightModePreference() {
    const savedMode = localStorage.getItem('nightMode');
    if (savedMode === 'enabled') {
      document.body.classList.add('night-mode');
      nightModeIcon.className = 'ri-sun-line';
    }
  }

  function showSeekAnimation(seconds, direction) {
    const icon = direction === 'forward' ? 'ri-fast-forward-fill' : 'ri-rewind-fill';
    const text = direction === 'forward' ? `+${seconds}s` : `-${seconds}s`;
    const animationClass = direction === 'forward' ? 'forward' : 'backward';
    
    seekAnimation.innerHTML = `<i class="${icon}"></i> ${text}`;
    seekAnimation.className = `seek-animation ${animationClass}`;
    seekAnimation.style.display = 'flex';
    
    seekAnimation.style.animation = 'none';
    setTimeout(() => {
      seekAnimation.style.animation = 'seekFade 2s ease-out';
    }, 10);
    
    setTimeout(() => {
      seekAnimation.style.display = 'none';
    }, 2000);
  }

  async function togglePictureInPicture() {
    if (!video) return;
    
    try {
      if (document.pictureInPictureElement) {
        await document.exitPictureInPicture();
        pipBtn.classList.remove('active');
        isPipActive = false;
        showToast('Picture-in-Picture disabled');
      } else {
        await video.requestPictureInPicture();
        pipBtn.classList.add('active');
        isPipActive = true;
        showToast('Picture-in-Picture enabled');
      }
    } catch (error) {
      console.error('Picture-in-Picture error:', error);
      showToast('Picture-in-Picture not supported or failed');
    }
  }

  function toggleAudioBoost() {
    if (!video) return;
    
    if (audioBoostLevel === 1.0) {
      audioBoostLevel = 1.5;
    } else if (audioBoostLevel === 1.5) {
      audioBoostLevel = 2.0;
    } else if (audioBoostLevel === 2.0) {
      audioBoostLevel = 2.5;
    } else if (audioBoostLevel === 2.5) {
      audioBoostLevel = 3.0;
    } else {
      audioBoostLevel = 1.0;
    }
    
    if (video.audioTracks && video.audioTracks.length > 0) {
      video.volume = Math.min(1.0, savedVolume * audioBoostLevel);
    } else {
      applyAudioBoost();
    }
    
    const boostPercent = Math.round(audioBoostLevel * 100);
    audioBoostText.textContent = `${boostPercent}%`;
    audioBoostValue.textContent = `${boostPercent}%`;
    
    if (audioBoostLevel > 1.0) {
      audioBoostBtn.classList.add('active');
      audioBoostIndicator.classList.add('show');
      setTimeout(() => {
        audioBoostIndicator.classList.remove('show');
      }, 2000);
    } else {
      audioBoostBtn.classList.remove('active');
    }
    
    showToast(`Audio boost: ${boostPercent}%`);
  }

  function applyAudioBoost() {
    if (!video) return;
    
    if (!window.audioContext) {
      window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      window.sourceNode = window.audioContext.createMediaElementSource(video);
      window.gainNode = window.audioContext.createGain();
      
      window.sourceNode.connect(window.gainNode);
      window.gainNode.connect(window.audioContext.destination);
    }
    
    window.gainNode.gain.value = audioBoostLevel;
    
    if (window.audioContext.state === 'suspended') {
      window.audioContext.resume();
    }
  }

  // ========== NEW: MOBILE LANDSCAPE ROTATION ==========
  function lockToLandscape() {
    if (!isMobile || !isFullscreen) return;
    
    try {
      // Try to lock orientation to landscape
      if (screen.orientation && screen.orientation.lock) {
        screen.orientation.lock('landscape').then(() => {
          console.log('Screen locked to landscape');
        }).catch(error => {
          console.log('Failed to lock orientation:', error);
          // Fallback: Use CSS transform for older browsers
          applyLandscapeFallback();
        });
      } else if (screen.lockOrientation) {
        // Legacy API
        screen.lockOrientation('landscape');
      } else if (screen.mozLockOrientation) {
        screen.mozLockOrientation('landscape');
      } else if (screen.msLockOrientation) {
        screen.msLockOrientation('landscape');
      } else {
        // Fallback for browsers that don't support orientation lock
        applyLandscapeFallback();
      }
    } catch (error) {
      console.error('Error locking orientation:', error);
      applyLandscapeFallback();
    }
  }

  function unlockOrientation() {
    if (!isMobile) return;
    
    try {
      if (screen.orientation && screen.orientation.unlock) {
        screen.orientation.unlock();
      } else if (screen.unlockOrientation) {
        screen.unlockOrientation();
      } else if (screen.mozUnlockOrientation) {
        screen.mozUnlockOrientation();
      } else if (screen.msUnlockOrientation) {
        screen.msUnlockOrientation();
      }
    } catch (error) {
      console.error('Error unlocking orientation:', error);
    }
  }

  function applyLandscapeFallback() {
    // CSS fallback for landscape mode
    if (isFullscreen && isMobile) {
      document.body.style.transform = 'rotate(90deg)';
      document.body.style.transformOrigin = 'center center';
      document.body.style.width = '100vh';
      document.body.style.height = '100vw';
      document.body.style.position = 'fixed';
      document.body.style.top = '50%';
      document.body.style.left = '50%';
      document.body.style.marginTop = '-50vw';
      document.body.style.marginLeft = '-50vh';
      
      // Adjust video container
      container.style.transform = 'rotate(-90deg)';
      container.style.transformOrigin = 'center center';
      container.style.width = '100vh';
      container.style.height = '100vw';
    }
  }

  function removeLandscapeFallback() {
    // Remove CSS fallback transformations
    document.body.style.transform = '';
    document.body.style.transformOrigin = '';
    document.body.style.width = '';
    document.body.style.height = '';
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.left = '';
    document.body.style.marginTop = '';
    document.body.style.marginLeft = '';
    
    container.style.transform = '';
    container.style.transformOrigin = '';
    container.style.width = '';
    container.style.height = '';
  }

  // ========== MAIN CLICK TO TOGGLE FUNCTION ==========
  function toggleControlsVisibility() {
    if (!isFullscreen || !video) return;
    
    if (areControlsVisible) {
      hideControls();
    } else {
      showControls();
    }
  }

  function showControls() {
    videoControls.classList.remove('hidden');
    areControlsVisible = true;
    
    if (controlsHideTimeout) clearTimeout(controlsHideTimeout);
    if (isFullscreen && video && !video.paused) {
      controlsHideTimeout = setTimeout(hideControls, CONTROLS_HIDE_DELAY);
    }
  }

  function hideControls() {
    if (!isFullscreen) return;
    
    videoControls.classList.add('hidden');
    areControlsVisible = false;
  }

  function initClickToggleControls() {
    const videoContainer = document.querySelector('.video-wrapper');
    
    videoContainer.addEventListener('click', (e) => {
      if (e.target === video || e.target.classList.contains('video-wrapper')) {
        toggleControlsVisibility();
      }
    });
  }

  function handleFullscreenChange() {
    isFullscreen = !!document.fullscreenElement;
    
    if (isFullscreen) {
      container.classList.add('fullscreen');
      
      // Mobile ??? fullscreen ???? ?? landscape mode activate ????
      if (isMobile) {
        lockToLandscape();
      }
      
      showControls();
      
      if (video && !video.paused) {
        if (controlsHideTimeout) clearTimeout(controlsHideTimeout);
        controlsHideTimeout = setTimeout(hideControls, CONTROLS_HIDE_DELAY);
      }
    } else {
      container.classList.remove('fullscreen');
      
      // Mobile ??? fullscreen ?? ???? ??? ?? orientation unlock ????
      if (isMobile) {
        unlockOrientation();
        removeLandscapeFallback();
      }
      
      videoControls.classList.remove('hidden');
      areControlsVisible = true;
    }
  }

  // ========== SCREEN ORIENTATION CHANGE HANDLER ==========
  function handleOrientationChange() {
    if (!isMobile) return;
    
    if (isFullscreen) {
      // Fullscreen ??? ????? landscape maintain ????
      if (window.orientation === 90 || window.orientation === -90) {
        // Already in landscape
        console.log('Device is in landscape mode');
      } else {
        // Portrait mode ??? ??, lock to landscape ????
        lockToLandscape();
      }
    }
  }

  function seekForward() {
    if (!video) return;
    const seekAmount = 10;
    video.currentTime = Math.min(video.duration, video.currentTime + seekAmount);
    showSeekAnimation(seekAmount, 'forward');
    savePlaybackTime(url, video.currentTime);
    if (isFullscreen) showControls();
  }

  function seekBackward() {
    if (!video) return;
    const seekAmount = 10;
    video.currentTime = Math.max(0, video.currentTime - seekAmount);
    showSeekAnimation(seekAmount, 'backward');
    savePlaybackTime(url, video.currentTime);
    if (isFullscreen) showControls();
  }

  function toggleControlsPanel() {
    controlsPanel.classList.toggle('open');
  }

  function hideSpinner() {
    spinner.style.display = 'none';
  }

  function goBack() {
    window.history.back();
  }

  function getStorageKey(url) {
    return "rangexcoder_playback_" + btoa(url).substring(0, 30);
  }

  function savePlaybackTime(url, time) {
    try {
      localStorage.setItem(getStorageKey(url), time);
    } catch (e) {
      console.warn("Cannot store playback time", e);
    }
  }

  function loadPlaybackTime(url) {
    return parseFloat(localStorage.getItem(getStorageKey(url))) || 0;
  }

  function updateProgress() {
    if (!video || isDraggingProgress) return;
    
    const percent = (video.currentTime / video.duration) * 100;
    progressBar.style.width = `${percent}%`;
    progressHandle.style.left = `${percent}%`;
    currentTimeEl.textContent = formatTime(video.currentTime);
  }

  function seekVideo(e) {
    if (!video) return;
    
    const rect = progressContainer.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    video.currentTime = percent * video.duration;
    updateProgress();
    
    if (isFullscreen) {
      showControls();
    }
  }

  function startProgressDrag(e) {
    if (!video) return;
    
    isDraggingProgress = true;
    progressContainer.classList.add('dragging');
    
    if (isFullscreen) {
      showControls();
    }
    
    if (e.type === 'mousedown') {
      e.preventDefault();
      document.addEventListener('mousemove', dragProgress);
      document.addEventListener('mouseup', stopProgressDrag);
    } else if (e.type === 'touchstart') {
      document.addEventListener('touchmove', dragProgress);
      document.addEventListener('touchend', stopProgressDrag);
    }
    
    updateProgressOnDrag(e);
  }

  function dragProgress(e) {
    if (!isDraggingProgress) return;
    
    if (e.type === 'touchmove') {
      e.preventDefault();
    }
    
    updateProgressOnDrag(e);
  }

  function updateProgressOnDrag(e) {
    if (!video) return;
    
    const rect = progressContainer.getBoundingClientRect();
    let clientX;
    
    if (e.type.includes('mouse')) {
      clientX = e.clientX;
    } else if (e.type.includes('touch')) {
      clientX = e.touches[0].clientX;
    }
    
    let percent = (clientX - rect.left) / rect.width;
    percent = Math.max(0, Math.min(1, percent));
    
    progressBar.style.width = `${percent * 100}%`;
    progressHandle.style.left = `${percent * 100}%`;
    
    const newTime = percent * video.duration;
    currentTimeEl.textContent = formatTime(newTime);
    
    video.currentTime = newTime;
    
    if (!isFullscreen) {
      savePlaybackTime(url, video.currentTime);
    }
  }

  function stopProgressDrag() {
    if (!isDraggingProgress) return;
    
    isDraggingProgress = false;
    progressContainer.classList.remove('dragging');
    
    document.removeEventListener('mousemove', dragProgress);
    document.removeEventListener('mouseup', stopProgressDrag);
    document.removeEventListener('touchmove', dragProgress);
    document.removeEventListener('touchend', stopProgressDrag);
    
    if (video) {
      savePlaybackTime(url, video.currentTime);
      showControls();
    }
  }

  function togglePlayPause() {
    if (!video) return;
    
    if (video.paused) {
      video.play();
      playPauseBtn.innerHTML = '<i class="ri-pause-fill"></i>';
      
      if (isFullscreen) {
        showControls();
        if (controlsHideTimeout) clearTimeout(controlsHideTimeout);
        controlsHideTimeout = setTimeout(hideControls, CONTROLS_HIDE_DELAY);
      }
    } else {
      video.pause();
      playPauseBtn.innerHTML = '<i class="ri-play-fill"></i>';
      showControls();
    }
  }

  function toggleMute() {
    if (!video) return;
    
    video.muted = !video.muted;
    
    if (video.muted) {
      volumeBtn.innerHTML = '<i class="ri-volume-mute-fill"></i>';
      volumeLevel.style.width = '0%';
    } else {
      volumeBtn.innerHTML = '<i class="ri-volume-up-fill"></i>';
      volumeLevel.style.width = `${video.volume * 100}%`;
    }
  }

  function changeVolume(e) {
    if (!video || !isFullscreen) return;
    
    const rect = volumeSlider.getBoundingClientRect();
    let percent = (e.clientX - rect.left) / rect.width;
    percent = Math.max(0, Math.min(1, percent));
    
    savedVolume = percent;
    video.volume = Math.min(1.0, percent * audioBoostLevel);
    video.muted = percent === 0;
    
    volumeLevel.style.width = `${percent * 100}%`;
    showControls();
    
    if (video.muted || percent === 0) {
      volumeBtn.innerHTML = '<i class="ri-volume-mute-fill"></i>';
    } else if (percent < 0.5) {
      volumeBtn.innerHTML = '<i class="ri-volume-down-fill"></i>';
    } else {
      volumeBtn.innerHTML = '<i class="ri-volume-up-fill"></i>';
    }
  }

  function changePlaybackSpeed(speed) {
    if (!video || !isFullscreen) return;
    
    currentPlaybackSpeed = speed;
    video.playbackRate = speed;
    speedBtn.textContent = `${speed}x`;
    showControls();
    
    document.querySelectorAll('.speed-option').forEach(option => {
      option.classList.toggle('active', parseFloat(option.dataset.speed) === speed);
    });
  }

  function changeQuality(level) {
    if (!hls || !isFullscreen) return;
    
    if (level === 'auto') {
      hls.currentLevel = -1;
    } else {
      const levels = hls.levels;
      for (let i = 0; i < levels.length; i++) {
        if (levels[i].height === parseInt(level)) {
          hls.currentLevel = i;
          break;
        }
      }
    }
    
    document.querySelectorAll('.quality-option').forEach(option => {
      option.classList.toggle('active', option.dataset.quality === level);
    });
    
    showControls();
  }

  function populateQualityOptions(levels) {
    qualityOptions.innerHTML = '';
    
    const autoOption = document.createElement('button');
    autoOption.className = 'quality-option active';
    autoOption.dataset.quality = 'auto';
    autoOption.textContent = 'Auto';
    autoOption.addEventListener('click', () => changeQuality('auto'));
    qualityOptions.appendChild(autoOption);
    
    levels.forEach(level => {
      const option = document.createElement('button');
      option.className = 'quality-option';
      option.dataset.quality = level.height;
      option.textContent = `${level.height}p`;
      option.addEventListener('click', () => changeQuality(level.height.toString()));
      qualityOptions.appendChild(option);
    });
  }

  function toggleFullscreen() {
    if (!document.fullscreenElement) {
      container.requestFullscreen().catch(err => {
        console.log(`Error attempting to enable fullscreen: ${err.message}`);
      });
    } else {
      document.exitFullscreen();
    }
  }

  function addMobileTapControls(el) {
    el.addEventListener('touchend', e => {
      const now = Date.now();
      const dt = now - lastTap;
      lastTap = now;
      if (dt < 300) {
        const x = e.changedTouches[0].clientX;
        const w = window.innerWidth;
        if (x < w / 2) {
          video.currentTime = Math.max(0, video.currentTime - 10);
          showSeekAnimation(10, 'backward');
        } else {
          video.currentTime = Math.min(video.duration, video.currentTime + 10);
          showSeekAnimation(10, 'forward');
        }
        showControls();
      }
    });
  }

  function showToast(message) {
    let toast = document.getElementById('globalToast');
    if (!toast) {
      toast = document.createElement('div');
      toast.id = 'globalToast';
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--primary);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 600;
        z-index: 9999;
        opacity: 0;
        transform: translateX(100px);
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      `;
      document.body.appendChild(toast);
    }
    
    toast.textContent = message;
    toast.style.opacity = '1';
    toast.style.transform = 'translateX(0)';
    
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(100px)';
    }, 3000);
  }

  function addKeyboardControls() {
    window.addEventListener('keydown', e => {
      if (!video) return;

      showControls();

      switch(e.code) {
        case 'Space':
          e.preventDefault();
          if (!speedHeld) {
            video.playbackRate = 3.0;
            speedHeld = true;
          }
          break;
      }

      switch(e.key.toLowerCase()) {
        case ' ':
          e.preventDefault();
          togglePlayPause();
          break;
        case 'arrowleft':
          e.preventDefault();
          seekBackward();
          break;
        case 'arrowright':
          e.preventDefault();
          seekForward();
          break;
        case 'arrowup':
          e.preventDefault();
          if (isFullscreen) {
            video.volume = Math.min(1, video.volume + 0.1);
            volumeLevel.style.width = `${video.volume * 100}%`;
          }
          break;
        case 'arrowdown':
          e.preventDefault();
          if (isFullscreen) {
            video.volume = Math.max(0, video.volume - 0.1);
            volumeLevel.style.width = `${video.volume * 100}%`;
          }
          break;
        case 'm':
          e.preventDefault();
          if (isFullscreen) {
            toggleMute();
          }
          break;
        case 'f':
          e.preventDefault();
          toggleFullscreen();
          break;
        case 'p':
          e.preventDefault();
          if (isFullscreen) {
            togglePictureInPicture();
          }
          break;
        case 'b':
          e.preventDefault();
          if (isFullscreen) {
            toggleAudioBoost();
          }
          break;
        case 'r':
          e.preventDefault();
          video.currentTime = 0;
          showSeekAnimation(video.currentTime, 'backward');
          break;
        case '0':
        case '1':
        case '2':
        case '3':
        case '4':
        case '5':
        case '6':
        case '7':
        case '8':
        case '9':
          e.preventDefault();
          const percent = parseInt(e.key) / 10;
          const seekTo = percent * video.duration;
          const diff = Math.round(seekTo - video.currentTime);
          video.currentTime = seekTo;
          showSeekAnimation(Math.abs(diff), diff > 0 ? 'forward' : 'backward');
          break;
      }
    });

    window.addEventListener('keyup', e => {
      if (e.code === 'Space' && speedHeld) {
        video.playbackRate = currentPlaybackSpeed;
        speedHeld = false;
      }
    });
  }

  function openDownloadModal() {
    downloadModal.style.display = "flex";
  }

  function closeDownloadModal() {
    downloadModal.style.display = "none";
  }

  function startDownloadWith1DM() {
    const intentUrl = `intent://${url}#Intent;package=idm.internet.download.manager;scheme=http;end`;
    
    window.location.href = intentUrl;
    
    setTimeout(function() {
      window.location.href = url;
    }, 500);
    
    closeDownloadModal();
  }

  function updateVideoEventListeners() {
    if (!video) return;
    
    video.addEventListener('pause', () => {
      showControls();
    });
    
    video.addEventListener('play', () => {
      if (isFullscreen) {
        showControls();
        if (controlsHideTimeout) clearTimeout(controlsHideTimeout);
        controlsHideTimeout = setTimeout(hideControls, CONTROLS_HIDE_DELAY);
      }
    });
    
    video.addEventListener('seeking', () => {
      showControls();
    });
    
    video.addEventListener('enterpictureinpicture', () => {
      pipBtn.classList.add('active');
      isPipActive = true;
      showToast('Entered Picture-in-Picture');
    });
    
    video.addEventListener('leavepictureinpicture', () => {
      pipBtn.classList.remove('active');
      isPipActive = false;
      showToast('Exited Picture-in-Picture');
    });
  }

  function initVideo(src) {
    video = document.createElement('video');
    video.src = src;
    video.controls = false;
    video.autoplay = true;
    video.setAttribute('playsinline', '');
    video.style.width = '100%';
    video.style.height = '100%';

    video.addEventListener('loadedmetadata', () => {
      const savedTime = loadPlaybackTime(src);
      if (savedTime > 5 && savedTime < video.duration - 5) {
        video.currentTime = savedTime;
      }
      durationEl.textContent = formatTime(video.duration);
      
      if (document.pictureInPictureEnabled) {
        pipBtn.style.display = 'flex';
      } else {
        pipBtn.style.display = 'none';
      }
    });

    video.addEventListener('timeupdate', () => {
      if (!video.seeking && !video.paused) {
        savePlaybackTime(src, video.currentTime);
        updateProgress();
      }
    });

    video.addEventListener('ended', () => {
      localStorage.removeItem(getStorageKey(src));
      playPauseBtn.innerHTML = '<i class="ri-play-fill"></i>';
      showControls();
    });

    video.addEventListener('loadeddata', hideSpinner);
    video.addEventListener('canplay', hideSpinner);
    
    playPauseBtn.addEventListener('click', togglePlayPause);
    progressContainer.addEventListener('click', seekVideo);
    progressContainer.addEventListener('mousedown', startProgressDrag);
    progressContainer.addEventListener('touchstart', startProgressDrag);
    volumeBtn.addEventListener('click', toggleMute);
    volumeSlider.addEventListener('click', changeVolume);
    
    speedOptions.querySelectorAll('.speed-option').forEach(option => {
      option.addEventListener('click', () => {
        changePlaybackSpeed(parseFloat(option.dataset.speed));
      });
    });
    
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    pipBtn.addEventListener('click', togglePictureInPicture);
    audioBoostBtn.addEventListener('click', toggleAudioBoost);
    
    qualityBtn.addEventListener('click', () => {
      if (isFullscreen) {
        showControls();
      }
    });
    
    container.insertBefore(video, spinner);
    addMobileTapControls(video);
    addKeyboardControls();
    updateVideoEventListeners();
  }

  function initializePlayer() {
    nightModeToggle.addEventListener('click', toggleNightMode);
    checkNightModePreference();
    
    initClickToggleControls();
    
    // Fullscreen change listeners
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange);
    document.addEventListener('MSFullscreenChange', handleFullscreenChange);
    
    // Mobile orientation change listener
    if (isMobile) {
      window.addEventListener('orientationchange', handleOrientationChange);
      window.addEventListener('resize', handleOrientationChange);
    }
    
    if (!url) {
      container.innerHTML = "<p class='text-danger text-center'>? No video URL provided!</p>";
      hideSpinner();
    } else if (url.match(/\.m3u8$/i)) {
      video = document.createElement('video');
      video.controls = false;
      video.autoplay = true;
      video.setAttribute('playsinline', '');
      video.style.width = '100%';
      video.style.height = '100%';
      container.insertBefore(video, spinner);

      if (Hls.isSupported()) {
        hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          hideSpinner();
          populateQualityOptions(hls.levels);
          showControls();
        });
        
        hls.on(Hls.Events.LEVEL_LOADED, () => {
          const savedTime = loadPlaybackTime(url);
          if (savedTime > 5) video.currentTime = savedTime;
          durationEl.textContent = formatTime(video.duration);
          
          if (document.pictureInPictureEnabled) {
            pipBtn.style.display = 'flex';
          } else {
            pipBtn.style.display = 'none';
          }
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.addEventListener('loadedmetadata', () => {
          const savedTime = loadPlaybackTime(url);
          if (savedTime > 5) video.currentTime = savedTime;
          durationEl.textContent = formatTime(video.duration);
          hideSpinner();
          showControls();
          
          if (document.pictureInPictureEnabled) {
            pipBtn.style.display = 'flex';
          } else {
            pipBtn.style.display = 'none';
          }
        });
      } else {
        container.innerHTML = "<p>Your browser does not support HLS playback.</p>";
        hideSpinner();
      }

      playPauseBtn.addEventListener('click', togglePlayPause);
      progressContainer.addEventListener('click', seekVideo);
      progressContainer.addEventListener('mousedown', startProgressDrag);
      progressContainer.addEventListener('touchstart', startProgressDrag);
      volumeBtn.addEventListener('click', toggleMute);
      volumeSlider.addEventListener('click', changeVolume);
      speedOptions.querySelectorAll('.speed-option').forEach(option => {
        option.addEventListener('click', () => {
          changePlaybackSpeed(parseFloat(option.dataset.speed));
        });
      });
      fullscreenBtn.addEventListener('click', toggleFullscreen);
      pipBtn.addEventListener('click', togglePictureInPicture);
      audioBoostBtn.addEventListener('click', toggleAudioBoost);
      
      video.addEventListener('timeupdate', () => {
        savePlaybackTime(url, video.currentTime);
        updateProgress();
      });
      
      video.addEventListener('ended', () => {
        localStorage.removeItem(getStorageKey(url));
        playPauseBtn.innerHTML = '<i class="ri-play-fill"></i>';
        showControls();
      });

      addMobileTapControls(video);
      addKeyboardControls();
      updateVideoEventListeners();

    } else if (url.match(/\.(mp4|webm|ogg)$/i)) {
      initVideo(url);
    } else {
      const iframe = document.createElement('iframe');
      iframe.src = url;
      iframe.allowFullscreen = true;
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.minHeight = '500px';
      iframe.onload = hideSpinner;
      container.appendChild(iframe);
      showControls();
    }
  }

  document.addEventListener('DOMContentLoaded', initializePlayer);
</script>
</body>
</html>