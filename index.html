?<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RangeXCoder - Professional Video Player</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    /* All existing CSS styles remain the same */
    :root {
      --primary: #4f46e5;
      --primary-dark: #3730a3;
      --secondary: #22c55e;
      --secondary-dark: #15803d;
      --danger: #e11d48;
      --danger-dark: #9f1239;
      --light: #f8fafc;
      --dark: #0f172a;
      --gray: #64748b;
      --gray-light: #cbd5e1;
      --card-bg: #ffffff;
      --card-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light);
      color: var(--dark);
      padding: 1rem;
      transition: background-color 0.3s, color 0.3s;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Night Mode Styles */
    body.night-mode {
      background-color: #0f172a;
      color: #e2e8f0;
    }

    body.night-mode .header {
      border-bottom-color: #334155;
    }

    body.night-mode .card-bg,
    body.night-mode .video-wrapper,
    body.night-mode #controlsPanel,
    body.night-mode #downloadModal .modal-content,
    body.night-mode #subtitleModal .modal-content {
      background-color: #1e293b;
      color: #e2e8f0;
    }

    body.night-mode .shortcut-item {
      background-color: rgba(79, 70, 229, 0.1);
    }

    body.night-mode .shortcut-action {
      color: #e2e8f0;
    }

    body.night-mode .video-controls {
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    }

    body.night-mode .progress-container {
      background-color: rgba(255,255,255,0.2);
    }

    body.night-mode .volume-slider {
      background-color: rgba(255,255,255,0.2);
    }

    body.night-mode .playback-speed-btn,
    body.night-mode .quality-btn,
    body.night-mode .subtitle-btn,
    body.night-mode .pip-btn,
    body.night-mode .audio-boost-btn {
      background: rgba(255,255,255,0.15);
      color: #e2e8f0;
    }

    body.night-mode .speed-options,
    body.night-mode .quality-options,
    body.night-mode .subtitle-options {
      background: rgba(30, 41, 59, 0.95);
      border: 1px solid #334155;
    }

    .header {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--gray-light);
    }

    .header h1 {
      font-weight: 800;
      color: var(--primary);
      margin: 0;
      font-size: 1.8rem;
      margin-right: auto;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo {
      width: 40px;
      height: 40px;
      background: var(--primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .header-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    /* Night Mode Toggle Button */
    .night-mode-toggle {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--gray);
      cursor: pointer;
      transition: color 0.3s;
      margin-right: 0.5rem;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .night-mode-toggle:hover {
      background-color: rgba(79, 70, 229, 0.1);
      color: var(--primary);
    }

    .controls-button, .download-button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .controls-button:hover {
      background-color: var(--primary-dark);
    }

    .download-button {
      background-color: var(--secondary);
    }

    .download-button:hover {
      background-color: var(--secondary-dark);
    }

    .player-container {
      max-width: 100%;
      margin: 0 auto;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .video-wrapper {
      background-color: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
      margin-bottom: 1.5rem;
      position: relative;
      width: 100%;
      height: 75vh;
      min-height: 500px;
    }

    video {
      width: 100%;
      height: 100%;
      display: block;
      outline: none;
      object-fit: contain;
    }

    /* Subtitle/Caption Styling */
    .subtitle-display {
      position: absolute;
      bottom: 100px;
      left: 0;
      right: 0;
      text-align: center;
      z-index: 50;
      pointer-events: none;
    }

    .subtitle-text {
      display: inline-block;
      background-color: rgba(0, 0, 0, 0.75);
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 1.1rem;
      max-width: 80%;
      line-height: 1.4;
      font-family: Arial, sans-serif;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }

    body.night-mode .subtitle-text {
      background-color: rgba(0, 0, 0, 0.85);
      color: #ffffff;
    }

    .video-controls {
      background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      opacity: 1;
      transition: opacity 0.5s ease;
    }

    /* Hide controls when video is playing */
    .video-wrapper:not(:hover) .video-controls:not(.force-show) {
      opacity: 0;
      pointer-events: none;
    }

    .video-wrapper:hover .video-controls {
      opacity: 1;
      pointer-events: all;
    }

    /* Force show controls */
    .video-controls.force-show {
      opacity: 1 !important;
      pointer-events: all !important;
    }

    .progress-container {
      width: 100%;
      height: 6px;
      background-color: rgba(255,255,255,0.3);
      border-radius: 3px;
      cursor: pointer;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      background-color: var(--primary);
      border-radius: 3px;
      width: 0%;
    }

    .progress-handle {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 16px;
      height: 16px;
      background-color: var(--primary);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }

    .progress-container:hover .progress-handle,
    .progress-container.dragging .progress-handle {
      opacity: 1;
    }

    .control-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .left-controls, .right-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .control-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      transition: color 0.2s;
    }

    .control-btn:hover {
      color: var(--primary);
    }

    /* Special control buttons */
    .subtitle-btn, .pip-btn, .audio-boost-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .subtitle-btn:hover, .pip-btn:hover, .audio-boost-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .subtitle-btn.active, .pip-btn.active, .audio-boost-btn.active {
      background: var(--primary);
    }

    .time-display {
      color: white;
      font-size: 0.9rem;
      font-weight: 500;
      font-family: 'Courier New', monospace;
      min-width: 130px;
      text-align: center;
    }

    .volume-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .volume-slider {
      width: 80px;
      height: 4px;
      background-color: rgba(255,255,255,0.3);
      border-radius: 2px;
      position: relative;
      cursor: pointer;
    }

    .volume-level {
      height: 100%;
      background-color: white;
      border-radius: 2px;
      width: 100%;
    }

    .playback-speed, .quality-selector, .subtitle-selector {
      position: relative;
    }

    .playback-speed-btn, .quality-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .playback-speed-btn:hover, .quality-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .speed-options, .quality-options, .subtitle-options {
      position: absolute;
      bottom: 100%;
      right: 0;
      background: rgba(0,0,0,0.8);
      border-radius: 6px;
      padding: 0.5rem;
      display: none;
      flex-direction: column;
      gap: 0.3rem;
      min-width: 100px;
      z-index: 100;
      max-height: 300px;
      overflow-y: auto;
    }

    .playback-speed:hover .speed-options, 
    .quality-selector:hover .quality-options,
    .subtitle-selector:hover .subtitle-options {
      display: flex;
    }

    .speed-option, .quality-option, .subtitle-option {
      background: none;
      border: none;
      color: white;
      padding: 0.4rem 0.8rem;
      text-align: left;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .speed-option:hover, .quality-option:hover, .subtitle-option:hover {
      background: rgba(255,255,255,0.1);
    }

    .speed-option.active, .quality-option.active, .subtitle-option.active {
      background: var(--primary);
    }

    .back-button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 10;
    }

    .back-button:hover {
      background-color: var(--primary-dark);
    }

    /* Seek Animation */
    .seek-animation {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(79, 70, 229, 0.9);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 50px;
      font-weight: bold;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      animation: seekFade 1.5s ease-out;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }

    @keyframes seekFade {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
      }
      15% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      70% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(1.2);
      }
    }

    /* Audio Boost Indicator */
    .audio-boost-indicator {
      position: absolute;
      top: 15px;
      right: 15px;
      background-color: rgba(34, 197, 94, 0.9);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .audio-boost-indicator.show {
      opacity: 1;
    }

    /* Loading Spinner */
    #loadingSpinner {
      position: absolute;
      z-index: 10;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      user-select: none;
      text-align: center;
      background: rgba(0,0,0,0.7);
      padding: 2rem;
      border-radius: 12px;
    }

    .dots-loader {
      display: inline-block;
      width: 60px;
      height: 20px;
    }

    .dots-loader > div {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin: 0 5px;
      background-color: var(--primary);
      border-radius: 50%;
      animation-name: dotsBounce;
      animation-duration: 1.4s;
      animation-iteration-count: infinite;
      animation-timing-function: ease-in-out;
    }

    .dots-loader > div:nth-child(1) { animation-delay: -0.32s; }
    .dots-loader > div:nth-child(2) { animation-delay: -0.16s; }

    @keyframes dotsBounce {
      0%, 80%, 100% { transform: scale(0); opacity: 0.3; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* Controls Panel */
    #controlsPanel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 380px;
      height: 100vh;
      background-color: var(--card-bg);
      box-shadow: -5px 0 15px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: right 0.3s ease;
      padding: 2rem;
      overflow-y: auto;
    }

    #controlsPanel.open {
      right: 0;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--gray-light);
    }

    .panel-header h2 {
      color: var(--primary);
      margin: 0;
    }

    .close-panel {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--gray);
      cursor: pointer;
      transition: color 0.2s;
    }

    .close-panel:hover {
      color: var(--danger);
    }

    .shortcuts-section {
      margin-bottom: 2rem;
    }

    .shortcuts-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--primary);
    }

    .shortcuts-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .shortcut-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.8rem;
      background-color: rgba(79, 70, 229, 0.05);
      border-radius: 8px;
    }

    .shortcut-key {
      background-color: var(--primary);
      color: white;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      min-width: 60px;
      text-align: center;
    }

    .shortcut-action {
      font-size: 0.9rem;
      color: var(--dark);
    }

    /* Download Modal Styles */
    #downloadModal {
      display: none;
      position: fixed;
      z-index: 1050;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
    }

    #downloadModal .modal-content {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 2rem;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    #downloadModal .modal-content h3 {
      margin-bottom: 1rem;
      color: var(--primary);
    }

    #downloadModal .modal-content p {
      margin-bottom: 1.5rem;
      font-size: 1rem;
      color: var(--dark);
    }

    #downloadModal .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
    }

    #downloadModal button.start-download {
      background-color: var(--secondary);
      color: white;
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #downloadModal button.start-download:hover {
      background-color: var(--secondary-dark);
    }

    #downloadModal button.cancel-download {
      background-color: var(--danger);
      color: white;
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #downloadModal button.cancel-download:hover {
      background-color: var(--danger-dark);
    }

    /* Subtitle Modal */
    #subtitleModal {
      display: none;
      position: fixed;
      z-index: 1050;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
    }

    #subtitleModal .modal-content {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 2rem;
      max-width: 500px;
      text-align: left;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    #subtitleModal .modal-content h3 {
      margin-bottom: 1rem;
      color: var(--primary);
      text-align: center;
    }

    .subtitle-upload-area {
      border: 2px dashed var(--gray-light);
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      margin-bottom: 1.5rem;
      cursor: pointer;
      transition: border-color 0.3s;
    }

    .subtitle-upload-area:hover {
      border-color: var(--primary);
    }

    .subtitle-upload-area i {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 1rem;
    }

    .subtitle-url-input {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid var(--gray-light);
      border-radius: 8px;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
    }

    .subtitle-url-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Download Progress */
    .download-progress {
      margin-top: 1rem;
      display: none;
    }

    .progress-text {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      color: var(--dark);
    }

    .progress-bar-container {
      width: 100%;
      height: 8px;
      background-color: var(--gray-light);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background-color: var(--secondary);
      width: 0%;
      transition: width 0.3s;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
      }
      
      .header h1 {
        font-size: 1.5rem;
      }
      
      .video-wrapper {
        height: 60vh;
        min-height: 400px;
      }
      
      .control-buttons {
        flex-wrap: wrap;
      }
      
      .right-controls {
        margin-top: 0.5rem;
        width: 100%;
        justify-content: space-between;
      }
      
      #controlsPanel {
        width: 300px;
      }
      
      .volume-slider {
        width: 60px;
      }
      
      .playback-speed-btn, .quality-btn, .subtitle-btn, .pip-btn, .audio-boost-btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
      }
      
      .time-display {
        min-width: 110px;
        font-size: 0.8rem;
      }
      
      .subtitle-text {
        font-size: 0.9rem;
        padding: 6px 12px;
        bottom: 120px;
      }
    }
    
    @media (max-width: 480px) {
      .video-wrapper {
        height: 50vh;
        min-height: 300px;
      }
      
      .header-controls {
        flex-direction: column;
        gap: 0.3rem;
      }
      
      .controls-button, .download-button {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }
      
      .night-mode-toggle {
        margin-right: 0;
        margin-bottom: 0.3rem;
      }
      
      .time-display {
        min-width: 90px;
        font-size: 0.75rem;
      }
      
      .subtitle-text {
        font-size: 0.8rem;
        padding: 4px 8px;
        bottom: 130px;
      }
    }
  </style>
</head>
<body>

  <div class="player-container">
    <!-- Header with title and controls -->
    <div class="header">
      <h1>
        <div class="logo">RX</div>
        RangeXCoder
      </h1>
      <div class="header-controls">
        <button class="night-mode-toggle" id="nightModeToggle" title="Toggle Night Mode">
          <i class="ri-moon-line" id="nightModeIcon"></i>
        </button>
        <button class="controls-button" onclick="toggleControlsPanel()">
          <i class="ri-keyboard-line"></i> Controls
        </button>
        <button class="download-button" onclick="openDownloadModal()">
          <i class="ri-download-line"></i> Download
        </button>
      </div>
    </div>

    <!-- Video player -->
    <div class="video-wrapper" id="playerContainer">
      <div id="loadingSpinner" aria-label="Loading video">
        <div class="dots-loader" aria-hidden="true">
          <div></div><div></div><div></div>
        </div>
        <p style="margin-top: 0.5rem; color: white; font-weight: 600;">Loading video...</p>
      </div>
      
      <!-- Seek Animation Container -->
      <div id="seekAnimation" class="seek-animation" style="display: none;"></div>
      
      <!-- Audio Boost Indicator -->
      <div id="audioBoostIndicator" class="audio-boost-indicator">
        <i class="ri-volume-up-fill"></i>
        <span id="audioBoostValue">100%</span>
      </div>
      
      <!-- Subtitle Display -->
      <div id="subtitleDisplay" class="subtitle-display" style="display: none;">
        <div class="subtitle-text" id="subtitleText"></div>
      </div>
      
      <button class="back-button" onclick="goBack()" title="Back to Lectures" aria-label="Back to Lectures">
        <i class="ri-arrow-left-line"></i> Back
      </button>
      
      <div class="video-controls">
        <div class="progress-container" id="progressContainer">
          <div class="progress-bar" id="progressBar"></div>
          <div class="progress-handle" id="progressHandle"></div>
        </div>
        
        <div class="control-buttons">
          <div class="left-controls">
            <button class="control-btn" id="playPauseBtn" title="Play/Pause">
              <i class="ri-play-fill"></i>
            </button>
            <div class="time-display">
              <span id="currentTime">0:00:00</span> / <span id="duration">0:00:00</span>
            </div>
          </div>
          
          <div class="right-controls">
            <!-- Audio Boost Button -->
            <button class="audio-boost-btn" id="audioBoostBtn" title="Audio Boost">
              <i class="ri-volume-up-line"></i>
              <span id="audioBoostText">100%</span>
            </button>
            
            <div class="volume-container">
              <button class="control-btn" id="volumeBtn" title="Mute/Unmute">
                <i class="ri-volume-up-fill"></i>
              </button>
              <div class="volume-slider" id="volumeSlider">
                <div class="volume-level" id="volumeLevel"></div>
              </div>
            </div>
            
            <!-- Picture-in-Picture Button -->
            <button class="pip-btn" id="pipBtn" title="Picture-in-Picture">
              <i class="ri-picture-in-picture-line"></i>
            </button>
            
            <!-- Subtitle Button -->
            <div class="subtitle-selector">
              <button class="subtitle-btn" id="subtitleBtn" title="Subtitles/Captions">
                <i class="ri-subtitle-line"></i>
              </button>
              <div class="subtitle-options" id="subtitleOptions">
                <button class="subtitle-option" data-subtitle="none">Off</button>
                <button class="subtitle-option active" data-subtitle="upload">Upload SRT</button>
                <button class="subtitle-option" data-subtitle="url">Load from URL</button>
              </div>
            </div>
            
            <div class="playback-speed">
              <button class="playback-speed-btn" id="speedBtn">1x</button>
              <div class="speed-options" id="speedOptions">
                <button class="speed-option" data-speed="0.25">0.25x</button>
                <button class="speed-option" data-speed="0.5">0.5x</button>
                <button class="speed-option" data-speed="0.75">0.75x</button>
                <button class="speed-option active" data-speed="1">1x</button>
                <button class="speed-option" data-speed="1.25">1.25x</button>
                <button class="speed-option" data-speed="1.5">1.5x</button>
                <button class="speed-option" data-speed="2">2x</button>
                <button class="speed-option" data-speed="2.5">2.5x</button>
                <button class="speed-option" data-speed="3">3x</button>
                <button class="speed-option" data-speed="4">4x</button>
                <button class="speed-option" data-speed="5">5x</button>
              </div>
            </div>
            
            <div class="quality-selector">
              <button class="quality-btn" id="qualityBtn">Quality</button>
              <div class="quality-options" id="qualityOptions">
                <!-- Quality options will be populated dynamically -->
              </div>
            </div>
            
            <button class="control-btn" id="fullscreenBtn" title="Fullscreen">
              <i class="ri-fullscreen-fill"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Controls Panel -->
  <div id="controlsPanel">
    <div class="panel-header">
      <h2>Player Controls</h2>
      <button class="close-panel" onclick="toggleControlsPanel()">
        <i class="ri-close-line"></i>
      </button>
    </div>
    
    <div class="shortcuts-section">
      <h3 class="shortcuts-title">Keyboard Shortcuts</h3>
      <div class="shortcuts-grid">
        <div class="shortcut-item">
          <span class="shortcut-key">Space</span>
          <span class="shortcut-action">Play/Pause</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">F</span>
          <span class="shortcut-action">Fullscreen</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">M</span>
          <span class="shortcut-action">Mute/Unmute</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">P</span>
          <span class="shortcut-action">Picture-in-Picture</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">S</span>
          <span class="shortcut-action">Subtitles</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">B</span>
          <span class="shortcut-action">Audio Boost</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">? ?</span>
          <span class="shortcut-action">Seek 10s</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">? ?</span>
          <span class="shortcut-action">Volume</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">0-9</span>
          <span class="shortcut-action">Seek to %</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">R</span>
          <span class="shortcut-action">Restart</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Hold Space</span>
          <span class="shortcut-action">Speed Boost (3x)</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Drag Progress</span>
          <span class="shortcut-action">Seek Video</span>
        </div>
      </div>
    </div>
    
    <div class="shortcuts-section">
      <h3 class="shortcuts-title">Mobile Controls</h3>
      <div class="shortcuts-grid">
        <div class="shortcut-item">
          <span class="shortcut-key">Tap</span>
          <span class="shortcut-action">Show/Hide Controls</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Double Tap Left</span>
          <span class="shortcut-action">Rewind 10s</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Double Tap Right</span>
          <span class="shortcut-action">Forward 10s</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Swipe Up/Down</span>
          <span class="shortcut-action">Brightness</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Swipe Left/Right</span>
          <span class="shortcut-action">Volume</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Drag/Hold Progress</span>
          <span class="shortcut-action">Seek Video</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Download Modal -->
  <div id="downloadModal" role="dialog" aria-modal="true" aria-labelledby="downloadModalTitle" aria-describedby="downloadModalDesc">
    <div class="modal-content">
      <h3 id="downloadModalTitle">Download Video</h3>
      <p id="downloadModalDesc">This will open the 1DM app to download the video.</p>
      
      <div class="modal-buttons">
        <button class="start-download" onclick="startDownloadWith1DM()" id="startDownloadBtn">Open in 1DM</button>
        <button class="cancel-download" onclick="closeDownloadModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Subtitle Modal -->
  <div id="subtitleModal" role="dialog" aria-modal="true" aria-labelledby="subtitleModalTitle">
    <div class="modal-content">
      <h3 id="subtitleModalTitle">Add Subtitles</h3>
      
      <div class="subtitle-upload-area" id="subtitleUploadArea">
        <i class="ri-upload-cloud-line"></i>
        <p>Drop SRT file here or click to upload</p>
        <input type="file" id="subtitleFileInput" accept=".srt,.vtt,.txt" style="display: none;">
      </div>
      
      <p style="text-align: center; margin: 1rem 0; font-weight: 600;">OR</p>
      
      <input type="text" class="subtitle-url-input" id="subtitleUrlInput" placeholder="Enter subtitle URL (SRT/VTT format)">
      
      <div class="modal-buttons">
        <button class="start-download" onclick="loadSubtitles()">Load Subtitles</button>
        <button class="cancel-download" onclick="closeSubtitleModal()">Cancel</button>
      </div>
    </div>
  </div>

<script>
  // Get URL parameters
  const params = new URLSearchParams(window.location.search);
  const title = params.get('title') || 'Video';
  let url = params.get('url') || '';
  if (!url && params.get('video')) {
    try { url = atob(params.get('video')); } catch {}
  }

  // DOM Elements
  const container = document.getElementById('playerContainer');
  const spinner = document.getElementById('loadingSpinner');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const currentTimeEl = document.getElementById('currentTime');
  const durationEl = document.getElementById('duration');
  const progressBar = document.getElementById('progressBar');
  const progressContainer = document.getElementById('progressContainer');
  const progressHandle = document.getElementById('progressHandle');
  const volumeBtn = document.getElementById('volumeBtn');
  const volumeSlider = document.getElementById('volumeSlider');
  const volumeLevel = document.getElementById('volumeLevel');
  const speedBtn = document.getElementById('speedBtn');
  const speedOptions = document.getElementById('speedOptions');
  const qualityBtn = document.getElementById('qualityBtn');
  const qualityOptions = document.getElementById('qualityOptions');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const controlsPanel = document.getElementById('controlsPanel');
  const downloadModal = document.getElementById("downloadModal");
  const startDownloadBtn = document.getElementById("startDownloadBtn");
  const nightModeToggle = document.getElementById("nightModeToggle");
  const nightModeIcon = document.getElementById("nightModeIcon");
  const seekAnimation = document.getElementById("seekAnimation");
  const videoControls = document.querySelector('.video-controls');
  
  // New elements for features
  const subtitleDisplay = document.getElementById('subtitleDisplay');
  const subtitleText = document.getElementById('subtitleText');
  const subtitleBtn = document.getElementById('subtitleBtn');
  const subtitleOptions = document.getElementById('subtitleOptions');
  const subtitleModal = document.getElementById('subtitleModal');
  const subtitleUploadArea = document.getElementById('subtitleUploadArea');
  const subtitleFileInput = document.getElementById('subtitleFileInput');
  const subtitleUrlInput = document.getElementById('subtitleUrlInput');
  const pipBtn = document.getElementById('pipBtn');
  const audioBoostBtn = document.getElementById('audioBoostBtn');
  const audioBoostText = document.getElementById('audioBoostText');
  const audioBoostIndicator = document.getElementById('audioBoostIndicator');
  const audioBoostValue = document.getElementById('audioBoostValue');

  // Global variables
  let video;
  let lastTap = 0;
  let speedHeld = false;
  let isDraggingProgress = false;
  let isDraggingVolume = false;
  let currentPlaybackSpeed = 1;
  let savedVolume = 1;
  let hls; // HLS.js instance
  let controlsHideTimeout;
  let isControlsVisible = true;
  const CONTROLS_HIDE_DELAY = 3000; // 3 seconds
  
  // New feature variables
  let subtitles = [];
  let currentSubtitleIndex = -1;
  let isSubtitlesEnabled = false;
  let subtitleFile = null;
  let audioBoostLevel = 1.0; // Default 100%
  const MAX_AUDIO_BOOST = 3.0; // 300% max boost
  let isPipActive = false;

  // ========== TIME FORMAT FUNCTION ==========
  function formatTime(seconds) {
    const hrs = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hrs > 0) {
      return `${hrs}:${mins < 10 ? '0' : ''}${mins}:${secs < 10 ? '0' : ''}${secs}`;
    } else {
      return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }
  }

  // ========== NIGHT MODE FUNCTIONS ==========
  function toggleNightMode() {
    document.body.classList.toggle('night-mode');
    if (document.body.classList.contains('night-mode')) {
      nightModeIcon.className = 'ri-sun-line';
      localStorage.setItem('nightMode', 'enabled');
    } else {
      nightModeIcon.className = 'ri-moon-line';
      localStorage.setItem('nightMode', 'disabled');
    }
  }

  function checkNightModePreference() {
    const savedMode = localStorage.getItem('nightMode');
    if (savedMode === 'enabled') {
      document.body.classList.add('night-mode');
      nightModeIcon.className = 'ri-sun-line';
    }
  }

  // ========== SEEK ANIMATION FUNCTIONS ==========
  function showSeekAnimation(seconds) {
    const icon = seconds > 0 ? 'ri-fast-forward-fill' : 'ri-rewind-fill';
    const text = seconds > 0 ? `+${seconds}s` : `${seconds}s`;
    
    seekAnimation.innerHTML = `<i class="${icon}"></i> ${text}`;
    seekAnimation.style.display = 'flex';
    
    // Reset animation
    seekAnimation.style.animation = 'none';
    setTimeout(() => {
      seekAnimation.style.animation = 'seekFade 1.5s ease-out';
    }, 10);
    
    // Hide after animation completes
    setTimeout(() => {
      seekAnimation.style.display = 'none';
    }, 1500);
  }

  // ========== SUBTITLE FUNCTIONS ==========
  function parseSRT(content) {
    const lines = content.split('\n');
    const subtitles = [];
    let currentSub = null;
    
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i].trim();
      
      if (!line) {
        if (currentSub) {
          subtitles.push(currentSub);
          currentSub = null;
        }
        continue;
      }
      
      if (!currentSub) {
        currentSub = { id: parseInt(line), text: '' };
      } else if (line.includes('-->')) {
        const timeMatch = line.match(/(\d{2}):(\d{2}):(\d{2}),(\d{3})\s*-->\s*(\d{2}):(\d{2}):(\d{2}),(\d{3})/);
        if (timeMatch) {
          const startTime = parseInt(timeMatch[1]) * 3600 + 
                           parseInt(timeMatch[2]) * 60 + 
                           parseInt(timeMatch[3]) + 
                           parseInt(timeMatch[4]) / 1000;
          const endTime = parseInt(timeMatch[5]) * 3600 + 
                         parseInt(timeMatch[6]) * 60 + 
                         parseInt(timeMatch[7]) + 
                         parseInt(timeMatch[8]) / 1000;
          currentSub.start = startTime;
          currentSub.end = endTime;
        }
      } else if (currentSub.start !== undefined) {
        currentSub.text += (currentSub.text ? '\n' : '') + line;
      }
    }
    
    if (currentSub) {
      subtitles.push(currentSub);
    }
    
    return subtitles;
  }

  function parseVTT(content) {
    const lines = content.split('\n');
    const subtitles = [];
    let currentSub = null;
    let inHeader = true;
    
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i].trim();
      
      if (inHeader && line.includes('-->')) {
        inHeader = false;
      }
      
      if (!inHeader) {
        if (line.includes('-->')) {
          if (currentSub) {
            subtitles.push(currentSub);
          }
          currentSub = { text: '' };
          
          const timeMatch = line.match(/(\d{2}):(\d{2}):(\d{2})\.(\d{3})\s*-->\s*(\d{2}):(\d{2}):(\d{2})\.(\d{3})/);
          if (timeMatch) {
            currentSub.start = parseInt(timeMatch[1]) * 3600 + 
                              parseInt(timeMatch[2]) * 60 + 
                              parseInt(timeMatch[3]) + 
                              parseInt(timeMatch[4]) / 1000;
            currentSub.end = parseInt(timeMatch[5]) * 3600 + 
                            parseInt(timeMatch[6]) * 60 + 
                            parseInt(timeMatch[7]) + 
                            parseInt(timeMatch[8]) / 1000;
          }
        } else if (currentSub && currentSub.start !== undefined && line && 
                  !line.startsWith('NOTE') && !line.startsWith('STYLE')) {
          currentSub.text += (currentSub.text ? '\n' : '') + line;
        }
      }
    }
    
    if (currentSub) {
      subtitles.push(currentSub);
    }
    
    return subtitles;
  }

  function updateSubtitleDisplay() {
    if (!video || !isSubtitlesEnabled || subtitles.length === 0) {
      subtitleDisplay.style.display = 'none';
      return;
    }
    
    const currentTime = video.currentTime;
    let subtitleToShow = null;
    
    // Find current subtitle
    for (let i = 0; i < subtitles.length; i++) {
      if (currentTime >= subtitles[i].start && currentTime <= subtitles[i].end) {
        subtitleToShow = subtitles[i];
        break;
      }
    }
    
    if (subtitleToShow) {
      subtitleText.textContent = subtitleToShow.text;
      subtitleDisplay.style.display = 'block';
    } else {
      subtitleDisplay.style.display = 'none';
    }
  }

  function loadSubtitles() {
    const url = subtitleUrlInput.value.trim();
    
    if (url) {
      // Load from URL
      fetch(url)
        .then(response => response.text())
        .then(content => {
          if (url.endsWith('.vtt')) {
            subtitles = parseVTT(content);
          } else {
            subtitles = parseSRT(content);
          }
          isSubtitlesEnabled = true;
          subtitleBtn.classList.add('active');
          subtitleBtn.innerHTML = '<i class="ri-subtitle-fill"></i>';
          closeSubtitleModal();
          showToast('Subtitles loaded successfully!');
        })
        .catch(error => {
          console.error('Error loading subtitles:', error);
          showToast('Failed to load subtitles. Please check the URL.');
        });
    } else if (subtitleFile) {
      // Read from file
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        if (subtitleFile.name.endsWith('.vtt')) {
          subtitles = parseVTT(content);
        } else {
          subtitles = parseSRT(content);
        }
        isSubtitlesEnabled = true;
        subtitleBtn.classList.add('active');
        subtitleBtn.innerHTML = '<i class="ri-subtitle-fill"></i>';
        closeSubtitleModal();
        showToast('Subtitles loaded successfully!');
      };
      reader.readAsText(subtitleFile);
    } else {
      showToast('Please upload a file or enter a URL.');
    }
  }

  function toggleSubtitles() {
    if (!isSubtitlesEnabled && subtitles.length === 0) {
      openSubtitleModal();
    } else {
      isSubtitlesEnabled = !isSubtitlesEnabled;
      if (isSubtitlesEnabled) {
        subtitleBtn.classList.add('active');
        subtitleBtn.innerHTML = '<i class="ri-subtitle-fill"></i>';
        subtitleDisplay.style.display = 'block';
        showToast('Subtitles enabled');
      } else {
        subtitleBtn.classList.remove('active');
        subtitleBtn.innerHTML = '<i class="ri-subtitle-line"></i>';
        subtitleDisplay.style.display = 'none';
        showToast('Subtitles disabled');
      }
    }
    showControls();
  }

  function openSubtitleModal() {
    subtitleModal.style.display = "flex";
    subtitleFile = null;
    subtitleUrlInput.value = '';
  }

  function closeSubtitleModal() {
    subtitleModal.style.display = "none";
  }

  // ========== PICTURE-IN-PICTURE FUNCTIONS ==========
  async function togglePictureInPicture() {
    if (!video) return;
    
    try {
      if (document.pictureInPictureElement) {
        await document.exitPictureInPicture();
        pipBtn.classList.remove('active');
        isPipActive = false;
        showToast('Picture-in-Picture disabled');
      } else {
        await video.requestPictureInPicture();
        pipBtn.classList.add('active');
        isPipActive = true;
        showToast('Picture-in-Picture enabled');
      }
    } catch (error) {
      console.error('Picture-in-Picture error:', error);
      showToast('Picture-in-Picture not supported or failed');
    }
    showControls();
  }

  // ========== AUDIO BOOST FUNCTIONS ==========
  function toggleAudioBoost() {
    if (!video) return;
    
    if (audioBoostLevel === 1.0) {
      // Increase to 150%
      audioBoostLevel = 1.5;
    } else if (audioBoostLevel === 1.5) {
      // Increase to 200%
      audioBoostLevel = 2.0;
    } else if (audioBoostLevel === 2.0) {
      // Increase to 250%
      audioBoostLevel = 2.5;
    } else if (audioBoostLevel === 2.5) {
      // Increase to 300%
      audioBoostLevel = 3.0;
    } else {
      // Reset to 100%
      audioBoostLevel = 1.0;
    }
    
    // Apply audio boost
    if (video.audioTracks && video.audioTracks.length > 0) {
      // For videos with audio tracks
      video.volume = Math.min(1.0, savedVolume * audioBoostLevel);
    } else {
      // Use Web Audio API for better control
      applyAudioBoost();
    }
    
    // Update UI
    const boostPercent = Math.round(audioBoostLevel * 100);
    audioBoostText.textContent = `${boostPercent}%`;
    audioBoostValue.textContent = `${boostPercent}%`;
    
    if (audioBoostLevel > 1.0) {
      audioBoostBtn.classList.add('active');
      audioBoostIndicator.classList.add('show');
      setTimeout(() => {
        audioBoostIndicator.classList.remove('show');
      }, 2000);
    } else {
      audioBoostBtn.classList.remove('active');
    }
    
    showControls();
    showToast(`Audio boost: ${boostPercent}%`);
  }

  function applyAudioBoost() {
    if (!video) return;
    
    // Create audio context if not exists
    if (!window.audioContext) {
      window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      window.sourceNode = window.audioContext.createMediaElementSource(video);
      window.gainNode = window.audioContext.createGain();
      
      window.sourceNode.connect(window.gainNode);
      window.gainNode.connect(window.audioContext.destination);
    }
    
    // Apply gain (volume boost)
    window.gainNode.gain.value = audioBoostLevel;
    
    // Resume audio context if suspended
    if (window.audioContext.state === 'suspended') {
      window.audioContext.resume();
    }
  }

  // ========== CONTROLS AUTO-HIDE FUNCTIONS ==========
  function hideControls() {
    if (!video || video.paused) return;
    
    videoControls.classList.remove('force-show');
    isControlsVisible = false;
  }

  function showControls() {
    videoControls.classList.add('force-show');
    isControlsVisible = true;
    
    // Auto-hide after delay if video is playing
    if (controlsHideTimeout) clearTimeout(controlsHideTimeout);
    if (video && !video.paused) {
      controlsHideTimeout = setTimeout(hideControls, CONTROLS_HIDE_DELAY);
    }
  }

  function toggleControlsVisibility() {
    if (isControlsVisible) {
      hideControls();
    } else {
      showControls();
    }
  }

  function initControlsAutoHide() {
    const videoContainer = document.querySelector('.video-wrapper');
    
    // Show controls on mouse move
    videoContainer.addEventListener('mousemove', () => {
      if (!video) return;
      showControls();
    });
    
    // Show controls on touch
    videoContainer.addEventListener('touchstart', () => {
      if (!video) return;
      showControls();
    });
    
    // Toggle controls on video click
    videoContainer.addEventListener('click', (e) => {
      if (e.target === video || e.target.classList.contains('video-wrapper')) {
        toggleControlsVisibility();
      }
    });
  }

  // ========== SEEK FUNCTIONS WITH ANIMATION ==========
  function seekForward() {
    if (!video) return;
    const seekAmount = 10;
    video.currentTime = Math.min(video.duration, video.currentTime + seekAmount);
    showSeekAnimation(seekAmount);
    savePlaybackTime(url, video.currentTime);
    showControls();
  }

  function seekBackward() {
    if (!video) return;
    const seekAmount = 10;
    video.currentTime = Math.max(0, video.currentTime - seekAmount);
    showSeekAnimation(-seekAmount);
    savePlaybackTime(url, video.currentTime);
    showControls();
  }

  // ========== CORE PLAYER FUNCTIONS ==========
  function toggleControlsPanel() {
    controlsPanel.classList.toggle('open');
  }

  function hideSpinner() {
    spinner.style.display = 'none';
  }

  function goBack() {
    window.history.back();
  }

  // Storage functions for playback position
  function getStorageKey(url) {
    return "rangexcoder_playback_" + btoa(url).substring(0, 30);
  }

  function savePlaybackTime(url, time) {
    try {
      localStorage.setItem(getStorageKey(url), time);
    } catch (e) {
      console.warn("Cannot store playback time", e);
    }
  }

  function loadPlaybackTime(url) {
    return parseFloat(localStorage.getItem(getStorageKey(url))) || 0;
  }

  // Update progress bar
  function updateProgress() {
    if (!video || isDraggingProgress) return;
    
    const percent = (video.currentTime / video.duration) * 100;
    progressBar.style.width = `${percent}%`;
    progressHandle.style.left = `${percent}%`;
    currentTimeEl.textContent = formatTime(video.currentTime);
    
    // Update subtitle display
    if (isSubtitlesEnabled) {
      updateSubtitleDisplay();
    }
  }

  // Seek video on progress bar click
  function seekVideo(e) {
    if (!video) return;
    
    const rect = progressContainer.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    video.currentTime = percent * video.duration;
    updateProgress();
    showControls();
  }

  // Start dragging progress bar
  function startProgressDrag(e) {
    if (!video) return;
    
    isDraggingProgress = true;
    progressContainer.classList.add('dragging');
    showControls();
    
    // Prevent default behavior for mouse and touch events
    if (e.type === 'mousedown') {
      e.preventDefault();
      document.addEventListener('mousemove', dragProgress);
      document.addEventListener('mouseup', stopProgressDrag);
    } else if (e.type === 'touchstart') {
      document.addEventListener('touchmove', dragProgress);
      document.addEventListener('touchend', stopProgressDrag);
    }
    
    // Update progress immediately
    updateProgressOnDrag(e);
  }

  // Drag progress bar
  function dragProgress(e) {
    if (!isDraggingProgress) return;
    
    // Prevent default behavior for touch events
    if (e.type === 'touchmove') {
      e.preventDefault();
    }
    
    updateProgressOnDrag(e);
  }

  // Update progress during drag
  function updateProgressOnDrag(e) {
    if (!video) return;
    
    const rect = progressContainer.getBoundingClientRect();
    let clientX;
    
    if (e.type.includes('mouse')) {
      clientX = e.clientX;
    } else if (e.type.includes('touch')) {
      clientX = e.touches[0].clientX;
    }
    
    let percent = (clientX - rect.left) / rect.width;
    percent = Math.max(0, Math.min(1, percent));
    
    // Update visual progress
    progressBar.style.width = `${percent * 100}%`;
    progressHandle.style.left = `${percent * 100}%`;
    
    // Update time display
    const newTime = percent * video.duration;
    currentTimeEl.textContent = formatTime(newTime);
    
    // Update video time (but don't save to storage during drag)
    video.currentTime = newTime;
  }

  // Stop dragging progress bar
  function stopProgressDrag() {
    if (!isDraggingProgress) return;
    
    isDraggingProgress = false;
    progressContainer.classList.remove('dragging');
    
    // Remove event listeners
    document.removeEventListener('mousemove', dragProgress);
    document.removeEventListener('mouseup', stopProgressDrag);
    document.removeEventListener('touchmove', dragProgress);
    document.removeEventListener('touchend', stopProgressDrag);
    
    // Save the final position
    if (video) {
      savePlaybackTime(url, video.currentTime);
      showControls();
    }
  }

  // Toggle play/pause
  function togglePlayPause() {
    if (!video) return;
    
    if (video.paused) {
      video.play();
      playPauseBtn.innerHTML = '<i class="ri-pause-fill"></i>';
      // Auto-hide controls after delay
      showControls();
    } else {
      video.pause();
      playPauseBtn.innerHTML = '<i class="ri-play-fill"></i>';
      // Keep controls visible when paused
      showControls();
    }
  }

  // Toggle mute
  function toggleMute() {
    if (!video) return;
    
    video.muted = !video.muted;
    showControls();
    
    if (video.muted) {
      volumeBtn.innerHTML = '<i class="ri-volume-mute-fill"></i>';
      volumeLevel.style.width = '0%';
    } else {
      volumeBtn.innerHTML = '<i class="ri-volume-up-fill"></i>';
      volumeLevel.style.width = `${video.volume * 100}%`;
    }
  }

  // Change volume
  function changeVolume(e) {
    if (!video) return;
    
    const rect = volumeSlider.getBoundingClientRect();
    let percent = (e.clientX - rect.left) / rect.width;
    percent = Math.max(0, Math.min(1, percent));
    
    savedVolume = percent;
    video.volume = Math.min(1.0, percent * audioBoostLevel);
    video.muted = percent === 0;
    
    volumeLevel.style.width = `${percent * 100}%`;
    showControls();
    
    if (video.muted || percent === 0) {
      volumeBtn.innerHTML = '<i class="ri-volume-mute-fill"></i>';
    } else if (percent < 0.5) {
      volumeBtn.innerHTML = '<i class="ri-volume-down-fill"></i>';
    } else {
      volumeBtn.innerHTML = '<i class="ri-volume-up-fill"></i>';
    }
  }

  // Change playback speed
  function changePlaybackSpeed(speed) {
    if (!video) return;
    
    currentPlaybackSpeed = speed;
    video.playbackRate = speed;
    speedBtn.textContent = `${speed}x`;
    showControls();
    
    // Update active state in speed options
    document.querySelectorAll('.speed-option').forEach(option => {
      option.classList.toggle('active', parseFloat(option.dataset.speed) === speed);
    });
  }

  // Change quality level (for HLS streams)
  function changeQuality(level) {
    if (!hls) return;
    
    if (level === 'auto') {
      hls.currentLevel = -1; // Auto quality
    } else {
      // Find the level index that matches the requested quality
      const levels = hls.levels;
      for (let i = 0; i < levels.length; i++) {
        if (levels[i].height === parseInt(level)) {
          hls.currentLevel = i;
          break;
        }
      }
    }
    
    // Update active state in quality options
    document.querySelectorAll('.quality-option').forEach(option => {
      option.classList.toggle('active', option.dataset.quality === level);
    });
    
    showControls();
  }

  // Populate quality options for HLS streams
  function populateQualityOptions(levels) {
    qualityOptions.innerHTML = '';
    
    // Add Auto option
    const autoOption = document.createElement('button');
    autoOption.className = 'quality-option active';
    autoOption.dataset.quality = 'auto';
    autoOption.textContent = 'Auto';
    autoOption.addEventListener('click', () => changeQuality('auto'));
    qualityOptions.appendChild(autoOption);
    
    // Add quality levels
    levels.forEach(level => {
      const option = document.createElement('button');
      option.className = 'quality-option';
      option.dataset.quality = level.height;
      option.textContent = `${level.height}p`;
      option.addEventListener('click', () => changeQuality(level.height.toString()));
      qualityOptions.appendChild(option);
    });
  }

  // Toggle fullscreen
  function toggleFullscreen() {
    if (!document.fullscreenElement) {
      container.requestFullscreen().catch(err => {
        console.log(`Error attempting to enable fullscreen: ${err.message}`);
      });
    } else {
      document.exitFullscreen();
    }
    showControls();
  }

  // Mobile double tap: 10s seek left/right
  function addMobileTapControls(el) {
    el.addEventListener('touchend', e => {
      const now = Date.now();
      const dt = now - lastTap;
      lastTap = now;
      if (dt < 300) {
        const x = e.changedTouches[0].clientX;
        const w = window.innerWidth;
        if (x < w / 2) {
          video.currentTime = Math.max(0, video.currentTime - 10);
          showSeekAnimation(-10);
        } else {
          video.currentTime = Math.min(video.duration, video.currentTime + 10);
          showSeekAnimation(10);
        }
        showControls();
      }
    });
  }

  // Toast notification
  function showToast(message) {
    // Create toast if not exists
    let toast = document.getElementById('globalToast');
    if (!toast) {
      toast = document.createElement('div');
      toast.id = 'globalToast';
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--primary);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 600;
        z-index: 9999;
        opacity: 0;
        transform: translateX(100px);
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      `;
      document.body.appendChild(toast);
    }
    
    toast.textContent = message;
    toast.style.opacity = '1';
    toast.style.transform = 'translateX(0)';
    
    // Auto hide after 3 seconds
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(100px)';
    }, 3000);
  }

  // Keyboard shortcuts
  function addKeyboardControls() {
    window.addEventListener('keydown', e => {
      if (!video) return;

      // Show controls on any key press
      showControls();

      switch(e.code) {
        case 'Space':
          e.preventDefault();
          if (!speedHeld) {
            video.playbackRate = 3.0;
            speedHeld = true;
          }
          break;
      }

      switch(e.key.toLowerCase()) {
        case ' ':
          e.preventDefault();
          togglePlayPause();
          break;
        case 'arrowleft':
          e.preventDefault();
          seekBackward();
          break;
        case 'arrowright':
          e.preventDefault();
          seekForward();
          break;
        case 'arrowup':
          e.preventDefault();
          video.volume = Math.min(1, video.volume + 0.1);
          volumeLevel.style.width = `${video.volume * 100}%`;
          break;
        case 'arrowdown':
          e.preventDefault();
          video.volume = Math.max(0, video.volume - 0.1);
          volumeLevel.style.width = `${video.volume * 100}%`;
          break;
        case 'm':
          e.preventDefault();
          toggleMute();
          break;
        case 'f':
          e.preventDefault();
          toggleFullscreen();
          break;
        case 'p':
          e.preventDefault();
          togglePictureInPicture();
          break;
        case 's':
          e.preventDefault();
          toggleSubtitles();
          break;
        case 'b':
          e.preventDefault();
          toggleAudioBoost();
          break;
        case 'r':
          e.preventDefault();
          video.currentTime = 0;
          showSeekAnimation(-video.currentTime);
          break;
        case '0':
        case '1':
        case '2':
        case '3':
        case '4':
        case '5':
        case '6':
        case '7':
        case '8':
        case '9':
          e.preventDefault();
          const percent = parseInt(e.key) / 10;
          const seekTo = percent * video.duration;
          const diff = Math.round(seekTo - video.currentTime);
          video.currentTime = seekTo;
          showSeekAnimation(diff);
          break;
      }
    });

    window.addEventListener('keyup', e => {
      if (e.code === 'Space' && speedHeld) {
        video.playbackRate = currentPlaybackSpeed;
        speedHeld = false;
      }
    });
  }

  // Download Modal Functions
  function openDownloadModal() {
    downloadModal.style.display = "flex";
  }

  function closeDownloadModal() {
    downloadModal.style.display = "none";
  }

  // New function to trigger 1DM download
  function startDownloadWith1DM() {
    // Create intent URL for 1DM
    const intentUrl = `intent://${url}#Intent;package=idm.internet.download.manager;scheme=http;end`;
    
    // Try to open 1DM app
    window.location.href = intentUrl;
    
    // Fallback: If 1DM is not installed, open the video URL directly
    setTimeout(function() {
      window.location.href = url;
    }, 500);
    
    closeDownloadModal();
  }

  // Update video event listeners for auto-hide
  function updateVideoEventListeners() {
    if (!video) return;
    
    // Show controls when video is paused
    video.addEventListener('pause', () => {
      showControls();
    });
    
    // Hide controls after delay when video plays
    video.addEventListener('play', () => {
      showControls();
      if (controlsHideTimeout) clearTimeout(controlsHideTimeout);
      controlsHideTimeout = setTimeout(hideControls, CONTROLS_HIDE_DELAY);
    });
    
    // Show controls when seeking
    video.addEventListener('seeking', () => {
      showControls();
    });
    
    // Update subtitle display on time update
    video.addEventListener('timeupdate', () => {
      if (isSubtitlesEnabled) {
        updateSubtitleDisplay();
      }
    });
    
    // Picture-in-Picture events
    video.addEventListener('enterpictureinpicture', () => {
      pipBtn.classList.add('active');
      isPipActive = true;
      showToast('Entered Picture-in-Picture');
    });
    
    video.addEventListener('leavepictureinpicture', () => {
      pipBtn.classList.remove('active');
      isPipActive = false;
      showToast('Exited Picture-in-Picture');
    });
  }

  // Initialize video element with resume playback
  function initVideo(src) {
    video = document.createElement('video');
    video.src = src;
    video.controls = false; // We're using custom controls
    video.autoplay = true;
    video.setAttribute('playsinline', '');
    video.style.width = '100%';
    video.style.height = '100%';

    video.addEventListener('loadedmetadata', () => {
      const savedTime = loadPlaybackTime(src);
      if (savedTime > 5 && savedTime < video.duration - 5) {
        video.currentTime = savedTime;
      }
      durationEl.textContent = formatTime(video.duration);
      
      // Check Picture-in-Picture support
      if (document.pictureInPictureEnabled) {
        pipBtn.style.display = 'flex';
      } else {
        pipBtn.style.display = 'none';
      }
    });

    video.addEventListener('timeupdate', () => {
      if (!video.seeking && !video.paused) {
        savePlaybackTime(src, video.currentTime);
        updateProgress();
      }
    });

    video.addEventListener('ended', () => {
      localStorage.removeItem(getStorageKey(src));
      playPauseBtn.innerHTML = '<i class="ri-play-fill"></i>';
      showControls();
    });

    video.addEventListener('loadeddata', hideSpinner);
    video.addEventListener('canplay', hideSpinner);
    
    // Play/pause button
    playPauseBtn.addEventListener('click', togglePlayPause);
    
    // Progress bar - click to seek
    progressContainer.addEventListener('click', seekVideo);
    
    // Progress bar - drag to seek
    progressContainer.addEventListener('mousedown', startProgressDrag);
    progressContainer.addEventListener('touchstart', startProgressDrag);
    
    // Volume controls
    volumeBtn.addEventListener('click', toggleMute);
    volumeSlider.addEventListener('click', changeVolume);
    
    // Speed controls
    speedOptions.querySelectorAll('.speed-option').forEach(option => {
      option.addEventListener('click', () => {
        changePlaybackSpeed(parseFloat(option.dataset.speed));
      });
    });
    
    // Fullscreen
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    
    // New feature buttons
    subtitleBtn.addEventListener('click', toggleSubtitles);
    pipBtn.addEventListener('click', togglePictureInPicture);
    audioBoostBtn.addEventListener('click', toggleAudioBoost);
    
    // Subtitle options
    subtitleOptions.querySelectorAll('.subtitle-option').forEach(option => {
      option.addEventListener('click', () => {
        if (option.dataset.subtitle === 'upload' || option.dataset.subtitle === 'url') {
          openSubtitleModal();
        } else if (option.dataset.subtitle === 'none') {
          isSubtitlesEnabled = false;
          subtitleBtn.classList.remove('active');
          subtitleBtn.innerHTML = '<i class="ri-subtitle-line"></i>';
          subtitleDisplay.style.display = 'none';
          showToast('Subtitles disabled');
        }
        showControls();
      });
    });
    
    // Subtitle file upload
    subtitleUploadArea.addEventListener('click', () => {
      subtitleFileInput.click();
    });
    
    subtitleFileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        subtitleFile = e.target.files[0];
        subtitleUploadArea.innerHTML = `
          <i class="ri-check-line" style="color: var(--secondary);"></i>
          <p>${subtitleFile.name} selected</p>
        `;
      }
    });
    
    // Drag and drop for subtitles
    subtitleUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      subtitleUploadArea.style.borderColor = 'var(--primary)';
      subtitleUploadArea.style.backgroundColor = 'rgba(79, 70, 229, 0.05)';
    });
    
    subtitleUploadArea.addEventListener('dragleave', () => {
      subtitleUploadArea.style.borderColor = '';
      subtitleUploadArea.style.backgroundColor = '';
    });
    
    subtitleUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      subtitleUploadArea.style.borderColor = '';
      subtitleUploadArea.style.backgroundColor = '';
      
      if (e.dataTransfer.files.length > 0) {
        subtitleFile = e.dataTransfer.files[0];
        if (subtitleFile.name.endsWith('.srt') || subtitleFile.name.endsWith('.vtt') || subtitleFile.name.endsWith('.txt')) {
          subtitleUploadArea.innerHTML = `
            <i class="ri-check-line" style="color: var(--secondary);"></i>
            <p>${subtitleFile.name} selected</p>
          `;
        } else {
          showToast('Please select a SRT or VTT file');
        }
      }
    });
    
    // Add to container
    container.insertBefore(video, spinner);
    addMobileTapControls(video);
    addKeyboardControls();
    updateVideoEventListeners();
  }

  // Initialize everything when DOM is loaded
  function initializePlayer() {
    // Set up night mode toggle
    nightModeToggle.addEventListener('click', toggleNightMode);
    checkNightModePreference();
    
    // Initialize controls auto-hide
    initControlsAutoHide();
    
    // Main player logic
    if (!url) {
      container.innerHTML = "<p class='text-danger text-center'>? No video URL provided!</p>";
      hideSpinner();
    } else if (url.match(/\.m3u8$/i)) {
      video = document.createElement('video');
      video.controls = false;
      video.autoplay = true;
      video.setAttribute('playsinline', '');
      video.style.width = '100%';
      video.style.height = '100%';
      container.insertBefore(video, spinner);

      if (Hls.isSupported()) {
        hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          hideSpinner();
          // Populate quality options when manifest is parsed
          populateQualityOptions(hls.levels);
          showControls(); // Show controls initially
        });
        
        hls.on(Hls.Events.LEVEL_LOADED, () => {
          const savedTime = loadPlaybackTime(url);
          if (savedTime > 5) video.currentTime = savedTime;
          durationEl.textContent = formatTime(video.duration);
          
          // Check Picture-in-Picture support
          if (document.pictureInPictureEnabled) {
            pipBtn.style.display = 'flex';
          } else {
            pipBtn.style.display = 'none';
          }
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.addEventListener('loadedmetadata', () => {
          const savedTime = loadPlaybackTime(url);
          if (savedTime > 5) video.currentTime = savedTime;
          durationEl.textContent = formatTime(video.duration);
          hideSpinner();
          showControls(); // Show controls initially
          
          // Check Picture-in-Picture support
          if (document.pictureInPictureEnabled) {
            pipBtn.style.display = 'flex';
          } else {
            pipBtn.style.display = 'none';
          }
        });
      } else {
        container.innerHTML = "<p>Your browser does not support HLS playback.</p>";
        hideSpinner();
      }

      // Add event listeners for custom controls
      playPauseBtn.addEventListener('click', togglePlayPause);
      progressContainer.addEventListener('click', seekVideo);
      progressContainer.addEventListener('mousedown', startProgressDrag);
      progressContainer.addEventListener('touchstart', startProgressDrag);
      volumeBtn.addEventListener('click', toggleMute);
      volumeSlider.addEventListener('click', changeVolume);
      speedOptions.querySelectorAll('.speed-option').forEach(option => {
        option.addEventListener('click', () => {
          changePlaybackSpeed(parseFloat(option.dataset.speed));
        });
      });
      fullscreenBtn.addEventListener('click', toggleFullscreen);
      
      // New feature buttons
      subtitleBtn.addEventListener('click', toggleSubtitles);
      pipBtn.addEventListener('click', togglePictureInPicture);
      audioBoostBtn.addEventListener('click', toggleAudioBoost);
      
      // Subtitle options
      subtitleOptions.querySelectorAll('.subtitle-option').forEach(option => {
        option.addEventListener('click', () => {
          if (option.dataset.subtitle === 'upload' || option.dataset.subtitle === 'url') {
            openSubtitleModal();
          } else if (option.dataset.subtitle === 'none') {
            isSubtitlesEnabled = false;
            subtitleBtn.classList.remove('active');
            subtitleBtn.innerHTML = '<i class="ri-subtitle-line"></i>';
            subtitleDisplay.style.display = 'none';
            showToast('Subtitles disabled');
          }
          showControls();
        });
      });
      
      // Subtitle file upload
      subtitleUploadArea.addEventListener('click', () => {
        subtitleFileInput.click();
      });
      
      subtitleFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          subtitleFile = e.target.files[0];
          subtitleUploadArea.innerHTML = `
            <i class="ri-check-line" style="color: var(--secondary);"></i>
            <p>${subtitleFile.name} selected</p>
          `;
        }
      });
      
      // Drag and drop for subtitles
      subtitleUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        subtitleUploadArea.style.borderColor = 'var(--primary)';
        subtitleUploadArea.style.backgroundColor = 'rgba(79, 70, 229, 0.05)';
      });
      
      subtitleUploadArea.addEventListener('dragleave', () => {
        subtitleUploadArea.style.borderColor = '';
        subtitleUploadArea.style.backgroundColor = '';
      });
      
      subtitleUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        subtitleUploadArea.style.borderColor = '';
        subtitleUploadArea.style.backgroundColor = '';
        
        if (e.dataTransfer.files.length > 0) {
          subtitleFile = e.dataTransfer.files[0];
          if (subtitleFile.name.endsWith('.srt') || subtitleFile.name.endsWith('.vtt') || subtitleFile.name.endsWith('.txt')) {
            subtitleUploadArea.innerHTML = `
              <i class="ri-check-line" style="color: var(--secondary);"></i>
              <p>${subtitleFile.name} selected</p>
            `;
          } else {
            showToast('Please select a SRT or VTT file');
          }
        }
      });
      
      video.addEventListener('timeupdate', () => {
        savePlaybackTime(url, video.currentTime);
        updateProgress();
      });
      
      video.addEventListener('ended', () => {
        localStorage.removeItem(getStorageKey(url));
        playPauseBtn.innerHTML = '<i class="ri-play-fill"></i>';
        showControls();
      });

      addMobileTapControls(video);
      addKeyboardControls();
      updateVideoEventListeners();

    } else if (url.match(/\.(mp4|webm|ogg)$/i)) {
      initVideo(url);
    } else {
      const iframe = document.createElement('iframe');
      iframe.src = url;
      iframe.allowFullscreen = true;
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.minHeight = '500px';
      iframe.onload = hideSpinner;
      container.appendChild(iframe);
      showControls(); // Show controls for iframe content
    }
  }

  // Start everything when DOM is loaded
  document.addEventListener('DOMContentLoaded', initializePlayer);
</script>
<script src="script.js"></script>
</body>
</html>