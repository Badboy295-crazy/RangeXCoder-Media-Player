<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RangeXCoder - Professional Video Player</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    /* All existing CSS styles remain the same */
    :root {
      --primary: #4f46e5;
      --primary-dark: #3730a3;
      --secondary: #22c55e;
      --secondary-dark: #15803d;
      --danger: #e11d48;
      --danger-dark: #9f1239;
      --light: #f8fafc;
      --dark: #0f172a;
      --gray: #64748b;
      --gray-light: #cbd5e1;
      --card-bg: #ffffff;
      --card-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light);
      color: var(--dark);
      padding: 1rem;
      transition: background-color 0.3s, color 0.3s;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--gray-light);
    }

    .header h1 {
      font-weight: 800;
      color: var(--primary);
      margin: 0;
      font-size: 1.8rem;
      margin-right: auto;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo {
      width: 40px;
      height: 40px;
      background: var(--primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .header-controls {
      display: flex;
      gap: 0.5rem;
    }

    .controls-button, .download-button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .controls-button:hover {
      background-color: var(--primary-dark);
    }

    .download-button {
      background-color: var(--secondary);
    }

    .download-button:hover {
      background-color: var(--secondary-dark);
    }

    .player-container {
      max-width: 100%;
      margin: 0 auto;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .video-wrapper {
      background-color: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
      margin-bottom: 1.5rem;
      position: relative;
      width: 100%;
      height: 75vh;
      min-height: 500px;
    }

    video {
      width: 100%;
      height: 100%;
      display: block;
      outline: none;
      object-fit: contain;
    }

    .video-controls {
      background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .video-wrapper:hover .video-controls {
      opacity: 1;
    }

    .progress-container {
      width: 100%;
      height: 6px;
      background-color: rgba(255,255,255,0.3);
      border-radius: 3px;
      cursor: pointer;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      background-color: var(--primary);
      border-radius: 3px;
      width: 0%;
    }

    .progress-handle {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 16px;
      height: 16px;
      background-color: var(--primary);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }

    .progress-container:hover .progress-handle,
    .progress-container.dragging .progress-handle {
      opacity: 1;
    }

    .control-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .left-controls, .right-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .control-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      transition: color 0.2s;
    }

    .control-btn:hover {
      color: var(--primary);
    }

    .time-display {
      color: white;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .volume-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .volume-slider {
      width: 80px;
      height: 4px;
      background-color: rgba(255,255,255,0.3);
      border-radius: 2px;
      position: relative;
      cursor: pointer;
    }

    .volume-level {
      height: 100%;
      background-color: white;
      border-radius: 2px;
      width: 100%;
    }

    .playback-speed, .quality-selector {
      position: relative;
    }

    .playback-speed-btn, .quality-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .playback-speed-btn:hover, .quality-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .speed-options, .quality-options {
      position: absolute;
      bottom: 100%;
      right: 0;
      background: rgba(0,0,0,0.8);
      border-radius: 6px;
      padding: 0.5rem;
      display: none;
      flex-direction: column;
      gap: 0.3rem;
      min-width: 100px;
      z-index: 100;
    }

    .playback-speed:hover .speed-options, .quality-selector:hover .quality-options {
      display: flex;
    }

    .speed-option, .quality-option {
      background: none;
      border: none;
      color: white;
      padding: 0.4rem 0.8rem;
      text-align: left;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .speed-option:hover, .quality-option:hover {
      background: rgba(255,255,255,0.1);
    }

    .speed-option.active, .quality-option.active {
      background: var(--primary);
    }

    .back-button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 10;
    }

    .back-button:hover {
      background-color: var(--primary-dark);
    }

    /* Loading Spinner */
    #loadingSpinner {
      position: absolute;
      z-index: 10;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      user-select: none;
      text-align: center;
      background: rgba(0,0,0,0.7);
      padding: 2rem;
      border-radius: 12px;
    }

    .dots-loader {
      display: inline-block;
      width: 60px;
      height: 20px;
    }

    .dots-loader > div {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin: 0 5px;
      background-color: var(--primary);
      border-radius: 50%;
      animation-name: dotsBounce;
      animation-duration: 1.4s;
      animation-iteration-count: infinite;
      animation-timing-function: ease-in-out;
    }

    .dots-loader > div:nth-child(1) { animation-delay: -0.32s; }
    .dots-loader > div:nth-child(2) { animation-delay: -0.16s; }

    @keyframes dotsBounce {
      0%, 80%, 100% { transform: scale(0); opacity: 0.3; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* Controls Panel */
    #controlsPanel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 380px;
      height: 100vh;
      background-color: var(--card-bg);
      box-shadow: -5px 0 15px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: right 0.3s ease;
      padding: 2rem;
      overflow-y: auto;
    }

    #controlsPanel.open {
      right: 0;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--gray-light);
    }

    .panel-header h2 {
      color: var(--primary);
      margin: 0;
    }

    .close-panel {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--gray);
      cursor: pointer;
      transition: color 0.2s;
    }

    .close-panel:hover {
      color: var(--danger);
    }

    .shortcuts-section {
      margin-bottom: 2rem;
    }

    .shortcuts-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--primary);
    }

    .shortcuts-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .shortcut-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.8rem;
      background-color: rgba(79, 70, 229, 0.05);
      border-radius: 8px;
    }

    .shortcut-key {
      background-color: var(--primary);
      color: white;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      min-width: 60px;
      text-align: center;
    }

    .shortcut-action {
      font-size: 0.9rem;
      color: var(--dark);
    }

    /* Download Modal Styles */
    #downloadModal {
      display: none;
      position: fixed;
      z-index: 1050;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
    }

    #downloadModal .modal-content {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 2rem;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    #downloadModal .modal-content h3 {
      margin-bottom: 1rem;
      color: var(--primary);
    }

    #downloadModal .modal-content p {
      margin-bottom: 1.5rem;
      font-size: 1rem;
      color: var(--dark);
    }

    #downloadModal .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
    }

    #downloadModal button.start-download {
      background-color: var(--secondary);
      color: white;
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #downloadModal button.start-download:hover {
      background-color: var(--secondary-dark);
    }

    #downloadModal button.cancel-download {
      background-color: var(--danger);
      color: white;
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #downloadModal button.cancel-download:hover {
      background-color: var(--danger-dark);
    }

    /* Download Progress */
    .download-progress {
      margin-top: 1rem;
      display: none;
    }

    .progress-text {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      color: var(--dark);
    }

    .progress-bar-container {
      width: 100%;
      height: 8px;
      background-color: var(--gray-light);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background-color: var(--secondary);
      width: 0%;
      transition: width 0.3s;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
      }
      
      .header h1 {
        font-size: 1.5rem;
      }
      
      .video-wrapper {
        height: 60vh;
        min-height: 400px;
      }
      
      .control-buttons {
        flex-wrap: wrap;
      }
      
      .right-controls {
        margin-top: 0.5rem;
        width: 100%;
        justify-content: space-between;
      }
      
      #controlsPanel {
        width: 300px;
      }
    }
    
    @media (max-width: 480px) {
      .video-wrapper {
        height: 50vh;
        min-height: 300px;
      }
      
      .header-controls {
        flex-direction: column;
        gap: 0.3rem;
      }
      
      .controls-button, .download-button {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>

  <div class="player-container">
    <!-- Header with title and controls -->
    <div class="header">
      <h1>
        <div class="logo">RX</div>
        RangeXCoder
      </h1>
      <div class="header-controls">
        <button class="controls-button" onclick="toggleControlsPanel()">
          <i class="ri-keyboard-line"></i> Controls
        </button>
        <button class="download-button" onclick="openDownloadModal()">
          <i class="ri-download-line"></i> Download
        </button>
      </div>
    </div>

    <!-- Video player -->
    <div class="video-wrapper" id="playerContainer">
      <div id="loadingSpinner" aria-label="Loading video">
        <div class="dots-loader" aria-hidden="true">
          <div></div><div></div><div></div>
        </div>
        <p style="margin-top: 0.5rem; color: white; font-weight: 600;">Loading video...</p>
      </div>
      
      <button class="back-button" onclick="goBack()" title="Back to Lectures" aria-label="Back to Lectures">
        <i class="ri-arrow-left-line"></i> Back
      </button>
      
      <div class="video-controls">
        <div class="progress-container" id="progressContainer">
          <div class="progress-bar" id="progressBar"></div>
          <div class="progress-handle" id="progressHandle"></div>
        </div>
        
        <div class="control-buttons">
          <div class="left-controls">
            <button class="control-btn" id="playPauseBtn" title="Play/Pause">
              <i class="ri-play-fill"></i>
            </button>
            <div class="time-display">
              <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
            </div>
          </div>
          
          <div class="right-controls">
            <div class="volume-container">
              <button class="control-btn" id="volumeBtn" title="Mute/Unmute">
                <i class="ri-volume-up-fill"></i>
              </button>
              <div class="volume-slider" id="volumeSlider">
                <div class="volume-level" id="volumeLevel"></div>
              </div>
            </div>
            
            <div class="playback-speed">
              <button class="playback-speed-btn" id="speedBtn">1x</button>
              <div class="speed-options" id="speedOptions">
                <button class="speed-option" data-speed="0.25">0.25x</button>
                <button class="speed-option" data-speed="0.5">0.5x</button>
                <button class="speed-option" data-speed="0.75">0.75x</button>
                <button class="speed-option active" data-speed="1">1x</button>
                <button class="speed-option" data-speed="1.25">1.25x</button>
                <button class="speed-option" data-speed="1.5">1.5x</button>
                <button class="speed-option" data-speed="2">2x</button>
                <button class="speed-option" data-speed="2.5">2.5x</button>
                <button class="speed-option" data-speed="3">3x</button>
                <button class="speed-option" data-speed="4">4x</button>
                <button class="speed-option" data-speed="5">5x</button>
              </div>
            </div>
            
            <div class="quality-selector">
              <button class="quality-btn" id="qualityBtn">Quality</button>
              <div class="quality-options" id="qualityOptions">
                <!-- Quality options will be populated dynamically -->
              </div>
            </div>
            
            <button class="control-btn" id="fullscreenBtn" title="Fullscreen">
              <i class="ri-fullscreen-fill"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Controls Panel -->
  <div id="controlsPanel">
    <div class="panel-header">
      <h2>Player Controls</h2>
      <button class="close-panel" onclick="toggleControlsPanel()">
        <i class="ri-close-line"></i>
      </button>
    </div>
    
    <div class="shortcuts-section">
      <h3 class="shortcuts-title">Keyboard Shortcuts</h3>
      <div class="shortcuts-grid">
        <div class="shortcut-item">
          <span class="shortcut-key">Space</span>
          <span class="shortcut-action">Play/Pause</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">F</span>
          <span class="shortcut-action">Fullscreen</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">M</span>
          <span class="shortcut-action">Mute/Unmute</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">← →</span>
          <span class="shortcut-action">Seek 10s</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">↑ ↓</span>
          <span class="shortcut-action">Volume</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">0-9</span>
          <span class="shortcut-action">Seek to %</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">R</span>
          <span class="shortcut-action">Restart</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Hold Space</span>
          <span class="shortcut-action">Speed Boost (3x)</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Drag Progress</span>
          <span class="shortcut-action">Seek Video</span>
        </div>
      </div>
    </div>
    
    <div class="shortcuts-section">
      <h3 class="shortcuts-title">Mobile Controls</h3>
      <div class="shortcuts-grid">
        <div class="shortcut-item">
          <span class="shortcut-key">Tap</span>
          <span class="shortcut-action">Show/Hide Controls</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Double Tap Left</span>
          <span class="shortcut-action">Rewind 10s</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Double Tap Right</span>
          <span class="shortcut-action">Forward 10s</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Swipe Up/Down</span>
          <span class="shortcut-action">Brightness</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Swipe Left/Right</span>
          <span class="shortcut-action">Volume</span>
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Drag/Hold Progress</span>
          <span class="shortcut-action">Seek Video</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Download Modal -->
  <div id="downloadModal" role="dialog" aria-modal="true" aria-labelledby="downloadModalTitle" aria-describedby="downloadModalDesc">
    <div class="modal-content">
      <h3 id="downloadModalTitle">Download Video</h3>
      <p id="downloadModalDesc">This will open the 1DM app to download the video.</p>
      
      <div class="modal-buttons">
        <button class="start-download" onclick="startDownloadWith1DM()" id="startDownloadBtn">Open in 1DM</button>
        <button class="cancel-download" onclick="closeDownloadModal()">Cancel</button>
      </div>
    </div>
  </div>

<script>
  // Get URL parameters
  const params = new URLSearchParams(window.location.search);
  const title = params.get('title') || 'Video';
  let url = params.get('url') || '';
  if (!url && params.get('video')) {
    try { url = atob(params.get('video')); } catch {}
  }

  // DOM Elements
  const container = document.getElementById('playerContainer');
  const spinner = document.getElementById('loadingSpinner');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const currentTimeEl = document.getElementById('currentTime');
  const durationEl = document.getElementById('duration');
  const progressBar = document.getElementById('progressBar');
  const progressContainer = document.getElementById('progressContainer');
  const progressHandle = document.getElementById('progressHandle');
  const volumeBtn = document.getElementById('volumeBtn');
  const volumeSlider = document.getElementById('volumeSlider');
  const volumeLevel = document.getElementById('volumeLevel');
  const speedBtn = document.getElementById('speedBtn');
  const speedOptions = document.getElementById('speedOptions');
  const qualityBtn = document.getElementById('qualityBtn');
  const qualityOptions = document.getElementById('qualityOptions');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const controlsPanel = document.getElementById('controlsPanel');
  const downloadModal = document.getElementById("downloadModal");
  const startDownloadBtn = document.getElementById("startDownloadBtn");

  // Global variables
  let video;
  let lastTap = 0;
  let speedHeld = false;
  let isDraggingProgress = false;
  let isDraggingVolume = false;
  let currentPlaybackSpeed = 1;
  let savedVolume = 1;
  let hls; // HLS.js instance

  // Toggle controls panel
  function toggleControlsPanel() {
    controlsPanel.classList.toggle('open');
  }

  // Hide loading spinner
  function hideSpinner() {
    spinner.style.display = 'none';
  }

  // Go back
  function goBack() {
    window.history.back();
  }

  // Storage functions for playback position
  function getStorageKey(url) {
    return "rangexcoder_playback_" + btoa(url).substring(0, 30);
  }

  function savePlaybackTime(url, time) {
    try {
      localStorage.setItem(getStorageKey(url), time);
    } catch (e) {
      console.warn("Cannot store playback time", e);
    }
  }

  function loadPlaybackTime(url) {
    return parseFloat(localStorage.getItem(getStorageKey(url))) || 0;
  }

  // Format time (seconds to MM:SS)
  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
  }

  // Update progress bar
  function updateProgress() {
    if (!video || isDraggingProgress) return;
    
    const percent = (video.currentTime / video.duration) * 100;
    progressBar.style.width = `${percent}%`;
    progressHandle.style.left = `${percent}%`;
    currentTimeEl.textContent = formatTime(video.currentTime);
  }

  // Seek video on progress bar click
  function seekVideo(e) {
    if (!video) return;
    
    const rect = progressContainer.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    video.currentTime = percent * video.duration;
    updateProgress();
  }

  // Start dragging progress bar
  function startProgressDrag(e) {
    if (!video) return;
    
    isDraggingProgress = true;
    progressContainer.classList.add('dragging');
    
    // Prevent default behavior for mouse and touch events
    if (e.type === 'mousedown') {
      e.preventDefault();
      document.addEventListener('mousemove', dragProgress);
      document.addEventListener('mouseup', stopProgressDrag);
    } else if (e.type === 'touchstart') {
      document.addEventListener('touchmove', dragProgress);
      document.addEventListener('touchend', stopProgressDrag);
    }
    
    // Update progress immediately
    updateProgressOnDrag(e);
  }

  // Drag progress bar
  function dragProgress(e) {
    if (!isDraggingProgress) return;
    
    // Prevent default behavior for touch events
    if (e.type === 'touchmove') {
      e.preventDefault();
    }
    
    updateProgressOnDrag(e);
  }

  // Update progress during drag
  function updateProgressOnDrag(e) {
    if (!video) return;
    
    const rect = progressContainer.getBoundingClientRect();
    let clientX;
    
    if (e.type.includes('mouse')) {
      clientX = e.clientX;
    } else if (e.type.includes('touch')) {
      clientX = e.touches[0].clientX;
    }
    
    let percent = (clientX - rect.left) / rect.width;
    percent = Math.max(0, Math.min(1, percent));
    
    // Update visual progress
    progressBar.style.width = `${percent * 100}%`;
    progressHandle.style.left = `${percent * 100}%`;
    
    // Update time display
    const newTime = percent * video.duration;
    currentTimeEl.textContent = formatTime(newTime);
    
    // Update video time (but don't save to storage during drag)
    video.currentTime = newTime;
  }

  // Stop dragging progress bar
  function stopProgressDrag() {
    if (!isDraggingProgress) return;
    
    isDraggingProgress = false;
    progressContainer.classList.remove('dragging');
    
    // Remove event listeners
    document.removeEventListener('mousemove', dragProgress);
    document.removeEventListener('mouseup', stopProgressDrag);
    document.removeEventListener('touchmove', dragProgress);
    document.removeEventListener('touchend', stopProgressDrag);
    
    // Save the final position
    if (video) {
      savePlaybackTime(url, video.currentTime);
    }
  }

  // Toggle play/pause
  function togglePlayPause() {
    if (!video) return;
    
    if (video.paused) {
      video.play();
      playPauseBtn.innerHTML = '<i class="ri-pause-fill"></i>';
    } else {
      video.pause();
      playPauseBtn.innerHTML = '<i class="ri-play-fill"></i>';
    }
  }

  // Toggle mute
  function toggleMute() {
    if (!video) return;
    
    video.muted = !video.muted;
    
    if (video.muted) {
      volumeBtn.innerHTML = '<i class="ri-volume-mute-fill"></i>';
      volumeLevel.style.width = '0%';
    } else {
      volumeBtn.innerHTML = '<i class="ri-volume-up-fill"></i>';
      volumeLevel.style.width = `${video.volume * 100}%`;
    }
  }

  // Change volume
  function changeVolume(e) {
    if (!video) return;
    
    const rect = volumeSlider.getBoundingClientRect();
    let percent = (e.clientX - rect.left) / rect.width;
    percent = Math.max(0, Math.min(1, percent));
    
    video.volume = percent;
    video.muted = percent === 0;
    
    volumeLevel.style.width = `${percent * 100}%`;
    
    if (video.muted || percent === 0) {
      volumeBtn.innerHTML = '<i class="ri-volume-mute-fill"></i>';
    } else if (percent < 0.5) {
      volumeBtn.innerHTML = '<i class="ri-volume-down-fill"></i>';
    } else {
      volumeBtn.innerHTML = '<i class="ri-volume-up-fill"></i>';
    }
  }

  // Change playback speed
  function changePlaybackSpeed(speed) {
    if (!video) return;
    
    currentPlaybackSpeed = speed;
    video.playbackRate = speed;
    speedBtn.textContent = `${speed}x`;
    
    // Update active state in speed options
    document.querySelectorAll('.speed-option').forEach(option => {
      option.classList.toggle('active', parseFloat(option.dataset.speed) === speed);
    });
  }

  // Change quality level (for HLS streams)
  function changeQuality(level) {
    if (!hls) return;
    
    if (level === 'auto') {
      hls.currentLevel = -1; // Auto quality
    } else {
      // Find the level index that matches the requested quality
      const levels = hls.levels;
      for (let i = 0; i < levels.length; i++) {
        if (levels[i].height === parseInt(level)) {
          hls.currentLevel = i;
          break;
        }
      }
    }
    
    // Update active state in quality options
    document.querySelectorAll('.quality-option').forEach(option => {
      option.classList.toggle('active', option.dataset.quality === level);
    });
  }

  // Populate quality options for HLS streams
  function populateQualityOptions(levels) {
    qualityOptions.innerHTML = '';
    
    // Add Auto option
    const autoOption = document.createElement('button');
    autoOption.className = 'quality-option active';
    autoOption.dataset.quality = 'auto';
    autoOption.textContent = 'Auto';
    autoOption.addEventListener('click', () => changeQuality('auto'));
    qualityOptions.appendChild(autoOption);
    
    // Add quality levels
    levels.forEach(level => {
      const option = document.createElement('button');
      option.className = 'quality-option';
      option.dataset.quality = level.height;
      option.textContent = `${level.height}p`;
      option.addEventListener('click', () => changeQuality(level.height.toString()));
      qualityOptions.appendChild(option);
    });
  }

  // Toggle fullscreen
  function toggleFullscreen() {
    if (!document.fullscreenElement) {
      container.requestFullscreen().catch(err => {
        console.log(`Error attempting to enable fullscreen: ${err.message}`);
      });
    } else {
      document.exitFullscreen();
    }
  }

  // Mobile double tap: 10s seek left/right
  function addMobileTapControls(el) {
    el.addEventListener('touchend', e => {
      const now = Date.now();
      const dt = now - lastTap;
      lastTap = now;
      if (dt < 300) {
        const x = e.changedTouches[0].clientX;
        const w = window.innerWidth;
        if (x < w / 2) video.currentTime = Math.max(0, video.currentTime - 10);
        else video.currentTime = Math.min(video.duration, video.currentTime + 10);
      }
    });
  }

  // Keyboard shortcuts
  function addKeyboardControls() {
    window.addEventListener('keydown', e => {
      if (!video) return;

      switch(e.code) {
        case 'Space':
          e.preventDefault();
          if (!speedHeld) {
            video.playbackRate = 3.0;
            speedHeld = true;
          }
          break;
      }

      switch(e.key) {
        case ' ':
          e.preventDefault();
          togglePlayPause();
          break;
        case 'ArrowLeft':
          video.currentTime = Math.max(0, video.currentTime - 10);
          break;
        case 'ArrowRight':
          video.currentTime = Math.min(video.duration, video.currentTime + 10);
          break;
        case 'ArrowUp':
          e.preventDefault();
          video.volume = Math.min(1, video.volume + 0.1);
          volumeLevel.style.width = `${video.volume * 100}%`;
          break;
        case 'ArrowDown':
          e.preventDefault();
          video.volume = Math.max(0, video.volume - 0.1);
          volumeLevel.style.width = `${video.volume * 100}%`;
          break;
        case 'm':
        case 'M':
          e.preventDefault();
          toggleMute();
          break;
        case 'f':
        case 'F':
          e.preventDefault();
          toggleFullscreen();
          break;
        case 'r':
        case 'R':
          e.preventDefault();
          video.currentTime = 0;
          break;
        case '0':
        case '1':
        case '2':
        case '3':
        case '4':
        case '5':
        case '6':
        case '7':
        case '8':
        case '9':
          e.preventDefault();
          const percent = parseInt(e.key) / 10;
          video.currentTime = percent * video.duration;
          break;
      }
    });

    window.addEventListener('keyup', e => {
      if (e.code === 'Space' && speedHeld) {
        video.playbackRate = currentPlaybackSpeed;
        speedHeld = false;
      }
    });
  }

  // Download Modal Functions
  function openDownloadModal() {
    downloadModal.style.display = "flex";
  }

  function closeDownloadModal() {
    downloadModal.style.display = "none";
  }

  // New function to trigger 1DM download
  function startDownloadWith1DM() {
    // Create intent URL for 1DM
    const intentUrl = `intent://${url}#Intent;package=idm.internet.download.manager;scheme=http;end`;
    
    // Try to open 1DM app
    window.location.href = intentUrl;
    
    // Fallback: If 1DM is not installed, open the video URL directly
    setTimeout(function() {
      window.location.href = url;
    }, 500);
    
    closeDownloadModal();
  }

  // Initialize video element with resume playback
  function initVideo(src) {
    video = document.createElement('video');
    video.src = src;
    video.controls = false; // We're using custom controls
    video.autoplay = true;
    video.setAttribute('playsinline', '');
    video.style.width = '100%';
    video.style.height = '100%';

    video.addEventListener('loadedmetadata', () => {
      const savedTime = loadPlaybackTime(src);
      if (savedTime > 5 && savedTime < video.duration - 5) {
        video.currentTime = savedTime;
      }
      durationEl.textContent = formatTime(video.duration);
    });

    video.addEventListener('timeupdate', () => {
      if (!video.seeking && !video.paused) {
        savePlaybackTime(src, video.currentTime);
        updateProgress();
      }
    });

    video.addEventListener('ended', () => {
      localStorage.removeItem(getStorageKey(src));
      playPauseBtn.innerHTML = '<i class="ri-play-fill"></i>';
    });

    video.addEventListener('loadeddata', hideSpinner);
    video.addEventListener('canplay', hideSpinner);
    
    // Play/pause button
    playPauseBtn.addEventListener('click', togglePlayPause);
    
    // Progress bar - click to seek
    progressContainer.addEventListener('click', seekVideo);
    
    // Progress bar - drag to seek
    progressContainer.addEventListener('mousedown', startProgressDrag);
    progressContainer.addEventListener('touchstart', startProgressDrag);
    
    // Volume controls
    volumeBtn.addEventListener('click', toggleMute);
    volumeSlider.addEventListener('click', changeVolume);
    
    // Speed controls
    speedOptions.querySelectorAll('.speed-option').forEach(option => {
      option.addEventListener('click', () => {
        changePlaybackSpeed(parseFloat(option.dataset.speed));
      });
    });
    
    // Fullscreen
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    
    // Add to container
    container.insertBefore(video, spinner);
    addMobileTapControls(video);
    addKeyboardControls();
  }

  // Main player logic
  if (!url) {
    container.innerHTML = "<p class='text-danger text-center'>❌ No video URL provided!</p>";
    hideSpinner();
  } else if (url.match(/\.m3u8$/i)) {
    video = document.createElement('video');
    video.controls = false;
    video.autoplay = true;
    video.setAttribute('playsinline', '');
    video.style.width = '100%';
    video.style.height = '100%';
    container.insertBefore(video, spinner);

    if (Hls.isSupported()) {
      hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(video);
      
      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        hideSpinner();
        // Populate quality options when manifest is parsed
        populateQualityOptions(hls.levels);
      });
      
      hls.on(Hls.Events.LEVEL_LOADED, () => {
        const savedTime = loadPlaybackTime(url);
        if (savedTime > 5) video.currentTime = savedTime;
        durationEl.textContent = formatTime(video.duration);
      });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = url;
      video.addEventListener('loadedmetadata', () => {
        const savedTime = loadPlaybackTime(url);
        if (savedTime > 5) video.currentTime = savedTime;
        durationEl.textContent = formatTime(video.duration);
        hideSpinner();
      });
    } else {
      container.innerHTML = "<p>Your browser does not support HLS playback.</p>";
      hideSpinner();
    }

    // Add event listeners for custom controls
    playPauseBtn.addEventListener('click', togglePlayPause);
    progressContainer.addEventListener('click', seekVideo);
    progressContainer.addEventListener('mousedown', startProgressDrag);
    progressContainer.addEventListener('touchstart', startProgressDrag);
    volumeBtn.addEventListener('click', toggleMute);
    volumeSlider.addEventListener('click', changeVolume);
    speedOptions.querySelectorAll('.speed-option').forEach(option => {
      option.addEventListener('click', () => {
        changePlaybackSpeed(parseFloat(option.dataset.speed));
      });
    });
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    
    video.addEventListener('timeupdate', () => {
      savePlaybackTime(url, video.currentTime);
      updateProgress();
    });
    
    video.addEventListener('ended', () => {
      localStorage.removeItem(getStorageKey(url));
      playPauseBtn.innerHTML = '<i class="ri-play-fill"></i>';
    });

    addMobileTapControls(video);
    addKeyboardControls();

  } else if (url.match(/\.(mp4|webm|ogg)$/i)) {
    initVideo(url);
  } else {
    const iframe = document.createElement('iframe');
    iframe.src = url;
    iframe.allowFullscreen = true;
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    iframe.style.minHeight = '500px';
    iframe.onload = hideSpinner;
    container.appendChild(iframe);
  }
</script>
<script src="script.js"></script>
</body>
</html>