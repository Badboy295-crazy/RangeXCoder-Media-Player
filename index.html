<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RangeXCoder - Video Player</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; color: #0f172a; padding:2rem; transition:0.3s; }
body.dark-mode { background-color:#0f172a; color:#f1f5f9; }

/* Buttons */
.theme-toggle, .download-button { position:fixed; top:15px; width:45px; height:45px; border:none; border-radius:50%; font-size:20px; cursor:pointer; z-index:1000; display:flex; align-items:center; justify-content:center; transition:0.3s; }
.theme-toggle { right:65px; background:#4f46e5; color:#fff; }
.theme-toggle:hover { background:#3730a3; }
.download-button { right:15px; background:#22c55e; color:#fff; }
.download-button:hover { background:#15803d; }

/* Points Box */
#pointsBox { position:fixed; top:15px; left:15px; background:#4f46e5; color:white; font-weight:bold; padding:8px 14px; border-radius:8px; z-index:1200; box-shadow:0 3px 10px rgba(0,0,0,0.2); display:flex; align-items:center; gap:10px; }
#pointsCountdown { font-size:0.85rem; color:#fff; opacity:0.8; }

/* Video container */
.video-container { max-width:900px; margin:auto; border:4px solid #4f46e5; border-radius:10px; overflow:hidden; background:white; box-shadow:0 0 15px rgba(0,0,0,0.2); aspect-ratio:16/9; position:relative; display:flex; align-items:center; justify-content:center; }
body.dark-mode .video-container { background:#1e293b; border-color:#818cf8; }
video, iframe { width:100%; height:100%; display:block; border-radius:6px; }

/* Loading Spinner */
#loadingSpinner { position:absolute; z-index:10; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; }
.dots-loader { display:inline-block; width:60px; height:20px; }
.dots-loader > div { display:inline-block; width:12px; height:12px; margin:0 5px; background-color:#6366f1; border-radius:50%; animation:dotsBounce 1.4s infinite ease-in-out; }
.dots-loader > div:nth-child(1){animation-delay:-0.32s;}
.dots-loader > div:nth-child(2){animation-delay:-0.16s;}
@keyframes dotsBounce { 0%,80%,100% { transform: scale(0); opacity:0.3; } 40%{ transform:scale(1); opacity:1; } }

/* Video Title */
#videoTitle { font-weight:700; color:#4f46e5; text-align:center; margin-bottom:1.5rem; cursor:default; user-select:none; max-width:90vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

/* Back Button */
.back-button { margin:2rem auto 0; display:block; background-color:#e11d48; color:#fff; border:none; padding:0.6rem 1.2rem; border-radius:6px; font-weight:500; cursor:pointer; max-width:220px; text-align:center; transition:0.3s; }
.back-button:hover { background-color:#9f1239; }

/* Speed Selector */
.speed-selector-wrapper { position:absolute; top:10px; right:10px; background:#4f46e5; padding:5px 10px; border-radius:8px; z-index:20; display:flex; align-items:center; gap:6px; color:white; font-weight:600; font-size:14px; }
.speed-selector-wrapper select { border:none; border-radius:4px; padding:2px 6px; font-size:14px; cursor:pointer; }

/* Download Modal */
#downloadModal { display:none; position:fixed; z-index:1050; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; }
#downloadModal .modal-content { background:white; border-radius:8px; padding:1.5rem 2rem; max-width:320px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.3); }
#downloadModal .modal-content h3 { margin-bottom:1rem; color:#4f46e5; }
#downloadModal .modal-content p { margin-bottom:1.5rem; color:#333; font-size:1rem; }
#downloadModal .modal-buttons { display:flex; justify-content:center; gap:1rem; }
#downloadModal .start-download { background:#22c55e; color:white; border:none; padding:0.5rem 1.2rem; border-radius:6px; font-weight:600; cursor:pointer; transition:0.3s; }
#downloadModal .start-download:hover { background:#15803d; }
#downloadModal .cancel-download { background:#ef4444; color:white; border:none; padding:0.5rem 1.2rem; border-radius:6px; font-weight:600; cursor:pointer; transition:0.3s; }
#downloadModal .cancel-download:hover { background:#b91c1c; }
</style>
</head>
<body>

<div id="pointsBox">Points: <span id="pointsValue">0</span> (<span id="pointsCountdown">60s</span>)</div>

<button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode"><i class="ri-moon-clear-line"></i></button>
<button class="download-button" onclick="openDownloadModal()" title="Download Video"><i class="ri-download-line"></i></button>

<h2 id="videoTitle">Loading...</h2>

<div class="video-container" id="playerContainer">
  <div id="loadingSpinner">
    <div class="dots-loader"><div></div><div></div><div></div></div>
    <p style="margin-top:0.5rem; color:#4f46e5; font-weight:600;">Loading video...</p>
  </div>
</div>

<button class="back-button" onclick="goBack()">? Back to Lectures</button>

<div id="downloadModal">
  <div class="modal-content">
    <h3>Download Video</h3>
    <p>Do you want to download this video?</p>
    <div class="modal-buttons">
      <button class="start-download" onclick="triggerDownload()">Start Download</button>
      <button class="cancel-download" onclick="closeDownloadModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
// ----------- URL & Elements -----------
const params = new URLSearchParams(window.location.search);
const title = params.get('title') || 'Video';
let url = params.get('url') || '';
if(!url && params.get('video')){ try{ url = atob(params.get('video')); } catch{} }

const container = document.getElementById('playerContainer');
const spinner = document.getElementById('loadingSpinner');
const videoTitle = document.getElementById('videoTitle');
videoTitle.innerText = title; videoTitle.title = title;

let video, lastTap=0, speedHeld=false;

// ----------- Helper Functions -----------
function toggleTheme(){ document.body.classList.toggle('dark-mode'); }
function hideSpinner(){ spinner.style.display='none'; }
function goBack(){ window.history.back(); }
function getStorageKey(url){ return "rangexcoder_playback_"+btoa(url).substring(0,30); }
function savePlaybackTime(url,time){ try{ localStorage.setItem(getStorageKey(url),time); } catch(e){} }
function loadPlaybackTime(url){ return parseFloat(localStorage.getItem(getStorageKey(url)))||0; }

function addMobileTapControls(el){
  el.addEventListener('touchend', e=>{
    const now=Date.now(); const dt=now-lastTap; lastTap=now;
    if(dt<300){ const x=e.changedTouches[0].clientX; const w=window.innerWidth;
      if(x<w/2) video.currentTime=Math.max(0,video.currentTime-10);
      else video.currentTime=Math.min(video.duration,video.currentTime+10);
    }
  });
}

function addSpeedSelector(){
  const wrapper=document.createElement('div'); wrapper.className='speed-selector-wrapper';
  const label=document.createElement('label'); label.textContent='Speed:';
  const select=document.createElement('select');
  [0.25,0.5,0.75,1,1.25,1.5,2,2.5,3].forEach(spd=>{ const o=document.createElement('option'); o.value=spd; o.textContent=spd+'x'; if(spd===1)o.selected=true; select.appendChild(o); });
  select.addEventListener('change',()=>{ if(video&&!speedHeld) video.playbackRate=parseFloat(select.value); });
  wrapper.appendChild(label); wrapper.appendChild(select); container.appendChild(wrapper);
  return select;
}

function addKeyboardControls(speedSelect){
  window.addEventListener('keydown', e=>{
    if(!video) return;
    switch(e.code){ case 'Space': e.preventDefault(); if(!speedHeld){ video.playbackRate=3; speedHeld=true; } break; }
    switch(e.key){
      case ' ': e.preventDefault(); video.paused?video.play():video.pause(); break;
      case 'ArrowLeft': video.currentTime=Math.max(0,video.currentTime-10); break;
      case 'ArrowRight': video.currentTime=Math.min(video.duration,video.currentTime+10); break;
      case 'ArrowUp': e.preventDefault(); video.volume=Math.min(1,video.volume+0.1); break;
      case 'ArrowDown': e.preventDefault(); video.volume=Math.max(0,video.volume-0.1); break;
      case 'r': case 'R': video.currentTime=0; break;
    }
  });
  window.addEventListener('keyup', e=>{ if(e.code==='Space' && speedHeld){ video.playbackRate=parseFloat(speedSelect.value)||1; speedHeld=false; } });
}

// ----------- Download Functions -----------
const downloadModal=document.getElementById("downloadModal");
function openDownloadModal(){ downloadModal.style.display="flex"; }
function closeDownloadModal(){ downloadModal.style.display="none"; }
function triggerDownload(){ closeDownloadModal(); if(!url){ alert("Video URL nahi mila."); return; } window.open(decodeURIComponent(url),'_blank'); }

// ----------- Gamified Points System -----------
let watchSeconds=0, points=0, countdown=60, countdownInterval;
const pointsValue = document.getElementById("pointsValue");
const pointsCountdown = document.getElementById("pointsCountdown");

function loadPoints(){
  points = parseInt(localStorage.getItem("video_points")||"0");
  pointsValue.textContent = points;
}
function savePoints(){ localStorage.setItem("video_points",points); }

function startPointsTimer(){
  countdown = 60; pointsCountdown.textContent = countdown + 's';
  countdownInterval = setInterval(()=>{
    if(video.paused) return;
    countdown--;
    if(countdown<=0){
      points+=2; savePoints(); pointsValue.textContent=points; countdown=60;
    }
    pointsCountdown.textContent = countdown + 's';
  },1000);
}

// ----------- Init Video -----------
function initVideo(src){
  video=document.createElement('video'); video.controls=true; video.autoplay=true; video.setAttribute('playsinline',''); video.style.borderRadius='6px';
  container.innerHTML=''; container.appendChild(video);
  if(src.match(/\.m3u8$/i)){
    if(Hls.isSupported()){ const hls=new Hls(); hls.loadSource(src); hls.attachMedia(video); hls.on(Hls.Events.MANIFEST_PARSED,()=>{ hideSpinner(); video.play(); startPointsTimer(); }); hls.on(Hls.Events.LEVEL_LOADED,()=>{ const saved=loadPlaybackTime(src); if(saved>5) video.currentTime=saved; }); }
    else if(video.canPlayType('application/vnd.apple.mpegurl')){ video.src=src; video.addEventListener('loadedmetadata',()=>{ const saved=loadPlaybackTime(src); if(saved>5) video.currentTime=saved; hideSpinner(); startPointsTimer(); }); }
    else{ container.innerHTML="<p>Your browser does not support HLS playback.</p>"; hideSpinner(); }
  } else if(src.match(/\.(mp4|webm|ogg)$/i)){ video.src=src; video.addEventListener('loadeddata',()=>{ hideSpinner(); startPointsTimer(); }); }
  video.addEventListener('loadedmetadata',()=>{ const saved=loadPlaybackTime(src); if(saved>5 && saved<video.duration-5) video.currentTime=saved; });
  video.addEventListener('timeupdate',()=>{ if(!video.seeking && !video.paused) savePlaybackTime(src,video.currentTime); });
  video.addEventListener('ended',()=>{ localStorage.removeItem(getStorageKey(src)); clearInterval(countdownInterval); });
  addMobileTapControls(video);
  const speedSelect=addSpeedSelector(); addKeyboardControls(speedSelect);
  loadPoints();
}

// ----------- Player Logic -----------
if(!url){ container.innerHTML="<p class='text-danger text-center'>No video URL provided!</p>"; hideSpinner(); }
else if(url.match(/\.(mp4|webm|ogg|m3u8)$/i)){ initVideo(url); }
else{ const iframe=document.createElement('iframe'); iframe.src=url; iframe.allowFullscreen=true; iframe.style.borderRadius='6px'; container.innerHTML=''; container.appendChild(iframe); setTimeout(hideSpinner,3000); }

</script>
</body>
</html>
