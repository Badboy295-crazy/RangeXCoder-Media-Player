<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RangeXCoder - Video Player</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f8fafc;
      color: #0f172a;
      padding: 2rem;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode {
      background-color: #0f172a;
      color: #f1f5f9;
    }
    .theme-toggle {
      position: fixed;
      top: 15px;
      right: 15px;
      background-color: #4f46e5;
      color: white;
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      font-size: 20px;
      cursor: pointer;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .theme-toggle:hover {
      background-color: #3730a3;
    }
    .video-container {
      max-width: 900px;
      margin: auto;
      border: 4px solid #4f46e5;
      border-radius: 10px;
      overflow: hidden;
      background-color: white;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      aspect-ratio: 16/9;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    body.dark-mode .video-container {
      background-color: #1e293b;
      border-color: #818cf8;
    }
    video, iframe {
      width: 100%;
      height: 100%;
      display: block;
      border-radius: 6px;
    }
    #loadingSpinner {
      position: absolute;
      z-index: 10;
      text-align: center;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      user-select: none;
    }
    .back-button {
      margin: 2rem auto 0;
      display: block;
      background-color: #e11d48;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      max-width: 220px;
      text-align: center;
      transition: background-color 0.3s;
    }
    .back-button:hover {
      background-color: #9f1239;
    }
    .download-button {
      background-color: #4f46e5;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      font-size: 1.2rem;
      border-radius: 6px;
      display: none;
      margin: 1rem auto;
      cursor: pointer;
      max-width: 220px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      user-select: none;
      transition: background-color 0.3s;
    }
    .download-button:hover {
      background-color: #3730a3;
    }

    /* Download Modal */
    #downloadModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      color: white;
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    #downloadModalContent {
      background: #1e293b;
      padding: 20px 30px;
      border-radius: 10px;
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    #downloadModalContent progress {
      width: 100%;
      height: 20px;
      border-radius: 5px;
      margin-bottom: 1rem;
      appearance: none;
    }
    #downloadModalContent button {
      margin: 8px 10px 0 10px;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s;
    }
    #saveFileBtn {
      background-color: #10b981;
      color: white;
      display: none;
    }
    #saveFileBtn:hover {
      background-color: #0f766e;
    }
    #cancelDownloadBtn {
      background-color: #ef4444;
      color: white;
    }
    #cancelDownloadBtn:hover {
      background-color: #b91c1c;
    }
  </style>
</head>
<body>

  <!-- Dark Mode Toggle Button -->
  <button class="theme-toggle" aria-label="Toggle Dark Mode" title="Toggle Dark Mode" onclick="toggleTheme()">
    <i class="ri-moon-clear-line"></i>
  </button>

  <h2 id="videoTitle" class="text-center mb-4">Loading...</h2>

  <div class="video-container" id="playerContainer">
    <div id="loadingSpinner">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading video...</p>
    </div>
  </div>

  <button id="downloadBtn" class="download-button" title="Download Video" aria-label="Download Video">
    <i class="ri-download-line"></i> Download Video
  </button>

  <button class="back-button" onclick="goBack()" title="Back to Lectures" aria-label="Back to Lectures">
    Back to Lectures
  </button>

  <!-- Download Modal -->
  <div id="downloadModal" class="d-flex" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDesc">
    <div id="downloadModalContent">
      <h4 id="modalTitle">Downloading...</h4>
      <progress id="progressBar" value="0" max="100"></progress>
      <p id="progressText">0%</p>
      <button id="saveFileBtn" aria-label="Save File">Save File</button>
      <button id="cancelDownloadBtn" aria-label="Cancel Download">Cancel</button>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const title = params.get('title') || 'Video';
    let url = params.get('url') || '';
    if (!url && params.get('video')) {
      try { url = atob(params.get('video')); } catch {}
    }

    const container = document.getElementById('playerContainer');
    const spinner = document.getElementById('loadingSpinner');
    const downloadBtn = document.getElementById('downloadBtn');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const downloadModal = document.getElementById('downloadModal');
    const saveFileBtn = document.getElementById('saveFileBtn');
    const cancelDownloadBtn = document.getElementById('cancelDownloadBtn');

    document.getElementById('videoTitle').innerText = title;

    let video;
    let controller;
    let downloadedBlob;
    let lastTap = 0;

    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
    }

    function hideSpinner() {
      spinner.style.display = 'none';
    }

    function goBack() {
      window.history.back();
    }

    // Setup download button for direct video files (mp4, webm, ogg)
    function setupDownload(src) {
      if (!src.match(/\.(mp4|webm|ogg)$/i)) return;
      downloadBtn.style.display = 'flex';
      downloadBtn.onclick = () => startDownload(src);
    }

    // Download with progress modal and cancel/save functionality
    async function startDownload(src) {
      downloadModal.style.display = 'flex';
      progressBar.value = 0;
      progressText.textContent = "0%";
      saveFileBtn.style.display = 'none';
      controller = new AbortController();

      try {
        const response = await fetch(src, { signal: controller.signal });
        if (!response.ok) throw new Error('Network error');
        const total = +response.headers.get('content-length');
        const reader = response.body.getReader();
        const chunks = [];
        let loaded = 0;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          chunks.push(value);
          loaded += value.length;
          if (total) {
            const percent = Math.floor((loaded / total) * 100);
            progressBar.value = percent;
            progressText.textContent = percent + '%';
          } else {
            progressText.textContent = `Downloaded ${loaded} bytes`;
          }
        }

        downloadedBlob = new Blob(chunks);
        saveFileBtn.style.display = 'inline-block';
        progressText.textContent = 'Download complete! Click "Save File" to save.';
      } catch (e) {
        if (e.name === 'AbortError') {
          progressText.textContent = 'Download cancelled.';
        } else {
          progressText.textContent = 'Download failed: ' + e.message;
        }
        saveFileBtn.style.display = 'none';
      }
    }

    saveFileBtn.onclick = () => {
      if (!downloadedBlob) return;
      const a = document.createElement('a');
      a.href = URL.createObjectURL(downloadedBlob);
      a.download = title + '.' + (url.split('.').pop().split(/\#|\?/)[0] || 'mp4');
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      closeDownloadModal();
    };

    cancelDownloadBtn.onclick = () => {
      if (controller) controller.abort();
      closeDownloadModal();
    };

    function closeDownloadModal() {
      downloadModal.style.display = 'none';
      downloadedBlob = null;
      progressBar.value = 0;
      progressText.textContent = '0%';
      saveFileBtn.style.display = 'none';
    }

    // Keyboard shortcut: ArrowLeft and ArrowRight for seeking 10 seconds
    window.addEventListener('keydown', e => {
      if (!video) return;
      if (e.key === 'ArrowLeft') {
        video.currentTime = Math.max(0, video.currentTime - 10);
      }
      if (e.key === 'ArrowRight') {
        video.currentTime = Math.min(video.duration, video.currentTime + 10);
      }
    });

    // Mobile double-tap seek left/right half of video container
    function addMobileTapControls(el) {
      el.addEventListener('touchend', e => {
        const now = Date.now();
        const dt = now - lastTap;
        lastTap = now;
        if (dt < 300) { // double tap detected
          const x = e.changedTouches[0].clientX;
          const w = window.innerWidth;
          if (x < w / 2) {
            // Double tap left half - rewind 10s
            video.currentTime = Math.max(0, video.currentTime - 10);
          } else {
            // Double tap right half - forward 10s
            video.currentTime = Math.min(video.duration, video.currentTime + 10);
          }
        }
      });
    }

    // Initialize video player with HLS or direct source
    function initVideo(src) {
      video = document.createElement('video');
      video.src = src;
      video.controls = true;
      video.autoplay = true;
      video.setAttribute('playsinline', '');
      video.style.borderRadius = '6px';
      video.addEventListener('loadeddata', () => {
        hideSpinner();
        setupDownload(src);
      });
      container.appendChild(video);
      addMobileTapControls(video);
    }

    // Load video or iframe based on URL
    if (url.match(/\.m3u8$/i)) {
      video = document.createElement('video');
      video.controls = true;
      video.autoplay = true;
      video.setAttribute('playsinline', '');
      container.appendChild(video);
      addMobileTapControls(video);

      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          hideSpinner();
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.addEventListener('loadedmetadata', () => {
          hideSpinner();
        });
      } else {
        container.innerHTML = "<p>Your browser does not support HLS playback.</p>";
        hideSpinner();
      }
    } else if (url.match(/\.(mp4|webm|ogg)$/i)) {
      initVideo(url);
    } else {
      // For URLs that are not direct video files, embed in iframe
      const iframe = document.createElement('iframe');
      iframe.src = url;
      iframe.allowFullscreen = true;
      iframe.style.borderRadius = '6px';
      iframe.onload = hideSpinner;
      container.appendChild(iframe);
    }

    // Abort download on page unload to avoid dangling requests
    window.addEventListener('beforeunload', () => {
      if (controller) controller.abort();
    });
  </script>

</body>
</html>
