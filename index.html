<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RangeXCoder - Video Player</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script>

<style>
body { font-family:'Segoe UI',sans-serif; background:#f8fafc; color:#0f172a; padding:2rem; transition:0.3s; }
body.dark-mode { background:#0f172a; color:#f1f5f9; }

.theme-toggle, .download-button, .chat-toggle-button { position: fixed; border:none; border-radius:50%; width:45px; height:45px; cursor:pointer; z-index:1000; display:flex; align-items:center; justify-content:center; font-size:20px; color:#fff; transition:0.3s; }
.theme-toggle { right:65px; top:15px; background:#4f46e5; } .theme-toggle:hover{background:#3730a3;}
.download-button { right:15px; top:15px; background:#22c55e; } .download-button:hover{background:#15803d;}
.chat-toggle-button { right:15px; top:70px; background:#3b82f6; } .chat-toggle-button:hover{background:#1d4ed8;}

.video-container { max-width:900px; margin:auto; border:4px solid #4f46e5; border-radius:10px; overflow:hidden; background:#fff; box-shadow:0 0 15px rgba(0,0,0,0.2); aspect-ratio:16/9; position:relative; display:flex; align-items:center; justify-content:center; transition:0.3s; }
body.dark-mode .video-container { background:#1e293b;border-color:#818cf8; }
video, iframe { width:100%; height:100%; border-radius:6px; display:block; }

#loadingSpinner { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-weight:600; color:#4f46e5; text-align:center; }
#videoTitle { font-weight:700;color:#4f46e5;text-align:center;margin-bottom:1.5rem; cursor:default; user-select:none; max-width:90vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.back-button { margin:2rem auto 0; display:block; background:#e11d48; color:#fff; border:none; padding:0.6rem 1.2rem; border-radius:6px; font-weight:500; cursor:pointer; max-width:220px; text-align:center; }
.back-button:hover { background:#9f1239; }

.speed-selector-wrapper { position:absolute; top:10px; right:10px; background:#4f46e5; padding:5px 10px; border-radius:8px; z-index:20; display:flex; align-items:center; gap:6px; color:white; font-weight:600; font-size:14px; }
.speed-selector-wrapper select { border:none; border-radius:4px; padding:2px 6px; font-size:14px; cursor:pointer; }

#downloadModal { display:none; position:fixed; z-index:1050; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; }
#downloadModal .modal-content { background:white; border-radius:8px; padding:1.5rem 2rem; max-width:320px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.3); }
#downloadModal .modal-content h3 { margin-bottom:1rem; color:#4f46e5; }
#downloadModal .modal-buttons { display:flex; justify-content:center; gap:1rem; }
#downloadModal button { border:none; border-radius:6px; padding:0.5rem 1.2rem; font-weight:600; cursor:pointer; transition:0.3s; }
#downloadModal .start-download{background:#22c55e;color:white;} #downloadModal .start-download:hover{background:#15803d;}
#downloadModal .cancel-download{background:#ef4444;color:white;} #downloadModal .cancel-download:hover{background:#b91c1c;}

#chatPanel { position:fixed; top:0; right:-400px; width:400px; height:100%; background:#f1f5f9; border-left:4px solid #4f46e5; box-shadow:-3px 0 15px rgba(0,0,0,0.2); transition:0.4s; z-index:1001; display:flex; flex-direction:column; padding:15px; border-radius:10px 0 0 10px; }
body.dark-mode #chatPanel { background:#1e293b; color:#f1f5f9; }
#chatPanel.open{right:0;}
.chat-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:5px;border-bottom:1px solid #cbd5e1;}
body.dark-mode .chat-header{border-color:#334155;}
#messages{flex:1;overflow-y:auto;padding:10px;background:#fff;border-radius:8px;border:1px solid #cbd5e1;margin-bottom:10px;}
body.dark-mode #messages{background:#0f172a;border-color:#334155;}
.message{max-width:75%;padding:10px 14px;margin-bottom:8px;border-radius:20px;word-wrap:break-word;display:inline-block;position:relative;font-size:0.9rem;transition:0.2s;clear:both;}
.message.left{background:#e0e7ff;color:#0f172a;float:left;border-top-left-radius:0;}
body.dark-mode .message.left{background:#1e293b;color:#f1f5f9;}
.message.right{background:#4f46e5;color:#fff;float:right;border-top-right-radius:0;}
body.dark-mode .message.right{color:#fff;}
.message .time{font-size:0.7rem;color:#64748b;position:absolute;bottom:-16px;right:10px;display:none;}
.message:hover .time{display:block;}
.chat-footer{display:flex;gap:8px;}
.chat-footer input{flex:1;border-radius:8px;border:1px solid #cbd5e1;padding:0.5rem 0.75rem;transition:0.2s;}
body.dark-mode .chat-footer input{border-color:#334155;background:#0f172a;color:#f1f5f9;}
.chat-footer button{border-radius:8px;padding:0.5rem 0.8rem;background:#4f46e5;border:none;color:#fff;cursor:pointer;transition:0.2s;}
.chat-footer button:hover{background:#3730a3;}
body.chat-open .video-container { margin-right:420px; }
body.chat-open .download-button, body.chat-open .chat-toggle-button, body.chat-open .theme-toggle{display:none!important;}
</style>
</head>
<body>

<!-- Add in your <body> -->
<div id="pointsBox" style="
  position:fixed;
  top:15px; left:15px;
  background:#4f46e5;
  color:white;
  font-weight:bold;
  padding:8px 14px;
  border-radius:8px;
  z-index:1200;
  box-shadow:0 3px 10px rgba(0,0,0,0.2);
">
  Points: <span id="pointsValue">0</span>
</div>


<button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode"><i class="ri-moon-clear-line"></i></button>
<button class="download-button" onclick="openDownloadModal()" title="Download Video"><i class="ri-download-line"></i></button>
<button class="chat-toggle-button" onclick="toggleChat()" title="Live Chat"><i class="ri-chat-3-line"></i></button>

<h2 id="videoTitle">Loading...</h2>
<div class="video-container" id="playerContainer">
  <div id="loadingSpinner">Loading...</div>
</div>
<button class="back-button" onclick="goBack()">Back to Lectures</button>

<div id="downloadModal">
  <div class="modal-content">
    <h3>Download Video</h3>
    <p>Do you want to download this video?</p>
    <div class="modal-buttons">
      <button class="start-download" onclick="triggerDownload()">Start Download</button>
      <button class="cancel-download" onclick="closeDownloadModal()">Cancel</button>
    </div>
  </div>
</div>

<div id="chatPanel">
  <div class="chat-header">
    <h5>Live Chat</h5>
    <button onclick="toggleChat()" class="btn-close"></button>
  </div>
  <div id="messages"></div>
  <input id="nameInput" class="form-control mb-2" placeholder="Your name (optional)" />
  <div class="chat-footer">
    <input id="msgInput" class="form-control" placeholder="Type your message..." />
    <button id="sendBtn" class="btn btn-primary">Send</button>
  </div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDL7oe84jwu7IolE2xu2mMR2NLDzDxZ_GM",
  authDomain: "rangexcoderlive.firebaseapp.com",
  databaseURL: "https://rangexcoderlive-default-rtdb.firebaseio.com",
  projectId: "rangexcoderlive",
  storageBucket: "rangexcoderlive.firebasestorage.app",
  messagingSenderId: "422087201100",
  appId: "1:422087201100:web:0ee5e264ae9d4715643fe9"
};
firebase.initializeApp(firebaseConfig);

// Get URL and title
const params = new URLSearchParams(window.location.search);
let videoUrl = decodeURIComponent(params.get("url") || "");
document.getElementById("videoTitle").innerText = params.get("title") || "Live Lecture Video";

const container = document.getElementById("playerContainer");
let video, lastTap=0;

// Helpers
function hideSpinner(){ const spinner=document.getElementById("loadingSpinner"); if(spinner) spinner.style.display="none"; }
function getStorageKey(url){return "rangexcoder_playback_"+btoa(url).substring(0,30);}
function savePlaybackTime(url,time){try{localStorage.setItem(getStorageKey(url),time);}catch(e){}}
function loadPlaybackTime(url){return parseFloat(localStorage.getItem(getStorageKey(url)))||0;}

// Mobile double tap
function addMobileTapControls(el){
  el.addEventListener('touchend', e=>{
    const now=Date.now(); const dt=now-lastTap; lastTap=now;
    if(dt<300){ const x=e.changedTouches[0].clientX; const w=window.innerWidth;
      if(x<w/2) video.currentTime=Math.max(0,video.currentTime-10);
      else video.currentTime=Math.min(video.duration,video.currentTime+10);
    }
  });
}

// Playback speed
function addSpeedSelector(){
  const speedWrapper=document.createElement('div'); speedWrapper.className='speed-selector-wrapper';
  const select=document.createElement('select'); [0.25,0.5,0.75,1,1.25,1.5,2,2.5,3].forEach(spd=>{
    const o=document.createElement('option'); o.value=spd; o.textContent=spd+'x'; if(spd===1)o.selected=true; select.appendChild(o);
  });
  select.addEventListener('change',()=>{ if(video) video.playbackRate=parseFloat(select.value); });
  speedWrapper.appendChild(document.createTextNode('Speed: ')); speedWrapper.appendChild(select);
  container.appendChild(speedWrapper);
  return select;
}

// Keyboard shortcuts
function addKeyboardControls(speedSelect){
  window.addEventListener('keydown',e=>{
    if(!video) return;
    switch(e.key){
      case ' ': e.preventDefault(); video.paused?video.play():video.pause(); break;
      case 'ArrowLeft': video.currentTime=Math.max(0,video.currentTime-10); break;
      case 'ArrowRight': video.currentTime=Math.min(video.duration,video.currentTime+10); break;
      case 'ArrowUp': e.preventDefault(); video.volume=Math.min(1,video.volume+0.1); break;
      case 'ArrowDown': e.preventDefault(); video.volume=Math.max(0,video.volume-0.1); break;
      case 'r': case 'R': video.currentTime=0; break;
    }
  });
}

// Initialize video
function initVideo(url){
  video=document.createElement('video'); video.controls=true; video.autoplay=true; video.setAttribute('playsinline',''); video.style.borderRadius='6px';
  container.innerHTML=''; container.appendChild(video);

  if(url.match(/\.m3u8$/i)){
    if(Hls.isSupported()){
      const hls=new Hls();
      hls.loadSource(url);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED,()=>{ hideSpinner(); video.play(); });
      hls.on(Hls.Events.ERROR,()=>{ hideSpinner(); console.error("HLS load error"); });
    } else { video.src=url; video.addEventListener('canplay',hideSpinner); }
  } else if(url.match(/\.(mp4|webm|ogg)$/i)){
    video.src=url; video.addEventListener('canplay',hideSpinner);
  } else {
    // fallback iframe for YouTube/Vimeo or other links
    const iframe=document.createElement('iframe');
    iframe.src=url;
    iframe.allowFullscreen=true;
    iframe.style.width='100%';
    iframe.style.height='100%';
    iframe.style.border='none';
    container.innerHTML=''; container.appendChild(iframe);
    setTimeout(hideSpinner,3000);
    return;
  }

  // Playback resume
  video.addEventListener('loadedmetadata',()=>{ const saved=loadPlaybackTime(url); if(saved>5 && saved<video.duration-5) video.currentTime=saved; });
  video.addEventListener('timeupdate',()=>{ if(!video.seeking&&!video.paused) savePlaybackTime(url,video.currentTime); });
  video.addEventListener('ended',()=>{ localStorage.removeItem(getStorageKey(url)); });

  addMobileTapControls(video);
  const speedSelect=addSpeedSelector();
  addKeyboardControls(speedSelect);
}

// Decide player type
if(!videoUrl){ container.innerHTML="<p class='text-danger text-center'>No video URL provided!</p>"; hideSpinner(); }
else { initVideo(videoUrl); }

// Download modal
const downloadModal=document.getElementById("downloadModal");
function openDownloadModal(){downloadModal.style.display="flex";}
function closeDownloadModal(){downloadModal.style.display="none";}
function triggerDownload(){ closeDownloadModal(); if(!videoUrl){alert("Video URL nahi mila."); return;} window.open(videoUrl,'_blank'); }

// Theme & Back
function toggleTheme(){document.body.classList.toggle('dark-mode');}
function goBack(){window.history.back();}

// Firebase Chat
const oneHourSlot=Math.floor(Date.now()/(1000*60*60));
const lectureId=btoa(videoUrl+"|"+oneHourSlot).replace(/=/g,"");
const chatPath="liveChat/"+lectureId;
const messagesEl=document.getElementById("messages");
const nameEl=document.getElementById("nameInput");
const msgEl=document.getElementById("msgInput");
const badWords=["badword1","badword2","xxx","fuck","shit"];
let lastMessageTime=0;
if(!localStorage.getItem("guestName")) localStorage.setItem("guestName","Guest"+Math.floor(Math.random()*1000));
nameEl.value=localStorage.getItem("guestName");

function cleanMessage(text){ let cleaned=text; badWords.forEach(w=>{const regex=new RegExp(w,"gi"); cleaned=cleaned.replace(regex,"****");}); return cleaned; }
function canSend(){ const now=Date.now(); if(now-lastMessageTime<5000){ alert("Wait 5 sec"); return false;} lastMessageTime=now; return true; }
function sendMsg(){ const text=msgEl.value.trim(); if(!text||!canSend()) return; const sender=nameEl.value.trim()||"Guest"; firebase.database().ref(chatPath).push({sender,text:cleanMessage(text),ts:Date.now()}); msgEl.value=""; }
document.getElementById("sendBtn").addEventListener("click",sendMsg);
msgEl.addEventListener("keypress",e=>{if(e.key==="Enter") sendMsg();});

firebase.database().ref(chatPath).limitToLast(100).on("child_added",snap=>{
  const m=snap.val(); if(!m) return;
  const div=document.createElement("div");
  const fullTime=new Date(m.ts);
  const alignment=(m.sender===nameEl.value.trim())?"right":"left";
  div.className="message "+alignment;
  div.innerHTML=`<strong>${escapeHtml(m.sender)}</strong><br/>${escapeHtml(m.text)}<span class="time">${fullTime.toLocaleString()}</span>`;
  messagesEl.appendChild(div);
  messagesEl.scrollTo({top:messagesEl.scrollHeight,behavior:"smooth"});
});

function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
function toggleChat(){ const panel=document.getElementById("chatPanel"); panel.classList.toggle("open"); document.body.classList.toggle("chat-open",panel.classList.contains("open")); }


// === POINT SYSTEM ===
let watchSeconds = 0;
let lastUpdate = Date.now();

function getCurrentUser() {
  return JSON.parse(localStorage.getItem("loggedInUser") || "null");
}
function getUserPoints(email) {
  return parseInt(localStorage.getItem("points_" + email) || "0");
}
function setUserPoints(email, pts) {
  localStorage.setItem("points_" + email, pts);
}

function setupVideoPoints(videoElement) {
  const user = getCurrentUser();
  if (!user) {
    console.warn("? Please login to earn points!");
    return;
  }
  let currentPoints = getUserPoints(user.email);
  document.getElementById("pointsValue").textContent = currentPoints;

  videoElement.addEventListener("timeupdate", () => {
    if (videoElement.paused || videoElement.seeking) return;

    const now = Date.now();
    if (now - lastUpdate >= 1000) { // at least 1 sec passed
      watchSeconds++;
      lastUpdate = now;

      // Every 60 sec = +2 points
      if (watchSeconds % 60 === 0) {
        currentPoints += 2;
        setUserPoints(user.email, currentPoints);
        document.getElementById("pointsValue").textContent = currentPoints;
        console.log("?? +2 Points! Total:", currentPoints);
      }
    }
  });
}

// Attach point system after video init
function initVideo(url) {
  // ... your existing video setup code ...

  // After creating <video> element:
  setupVideoPoints(video);
}

</script>
</body>
</html>
